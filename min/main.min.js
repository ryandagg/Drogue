var GameSpace=function(){var t=30,e=20,o=16,s=4,n=6,a=12,r=function(t){return"#"+String(t[0])+"-"+String(t[1])},h=function(t){var e=t[0],i="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?i+=t[t.length-1]:(i+=t[t.length-2],i+=t[t.length-1]),[Number(e),Number(i)]},l=function Q(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?Q(t[i]):t[i]);return e},c=function(t){var e=h(t),i=F.map[e[1]][e[0]];$("#"+t).parent().append("<div class='text-popup'>"+i.inspectText+"</br><span class='close-popup'>close</span></div>")},p=function(t){$("#messages").prepend("<p class='a-message'>"+t+"</p>")},u=function(){X++,p("----------- Turn "+X+" -----------");for(var t=0;t<G.length;t++)f(G[t]);P.regen(),$("#hp").text("HP: "+Math.floor(P.health)),P.drawInventory()},f=function(t){var e=F.createPFMatrix(F.map);e[t.y][t.x]=0;var i=new PF.Grid(F.columns,F.rows,e),o=U.findPath(t.x,t.y,P.x,P.y,i);if(o.length>0&&o.length<11){var s=o[1][0]-t.x,n=o[1][1]-t.y;2===o.length?t.combatHandler(P):F.map[o[1][1]][o[1][0]].monster||F.updateActor(s,n,t)}t.regen()},d=function(i){F=new m(t,e,F.depth+i),i>0?F.initializeMap("up"):0>i&&F.initializeMap("down"),resizeTiles(),resizeText()},m=function(t,e,i){this.rows=e,this.columns=t,this.depth=i,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],i=0;i<this.columns;i++)e.push(new v(i,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var i=t.upLeftCornerY+1;i<t.height+t.upLeftCornerY-1;i++)for(var o=t.upLeftCornerX+1;o<t.width+t.upLeftCornerX-1;o++)e(o,i)},this.createRoom=function(t,e){for(var i=t.xCenter-Math.floor(t.width/2),o=t.yCenter-Math.floor(t.height/2),s=0;s<t.height;s++)for(var n=0;n<t.width;n++)0===s||s===t.height-1?e[s+o][n+i]=new w(n+i,s+o):(0===n||n===t.width-1)&&(e[s+o][n+i]=new w(n+i,s+o))},this.roomOverlapCheck=function(t,e){for(var i=t.upLeftCornerY;i<t.upLeftCornerY+t.height;i++)for(var o=t.upLeftCornerX;o<t.upLeftCornerX+t.width;o++)if("wall"===e[i][o].class)return!1;return!0},this.checkDoorPath=function(t,e,i){return"dot"===i[e][t-1].class&&"dot"===i[e][t+1].class?!0:"dot"===i[e-1][t].class&&"dot"===i[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var i=0,o=0;o<t.length;o++){var s=t[o].xCenter-Math.floor(t[o].width/2),n=t[o].yCenter-Math.floor(t[o].height/2);t:for(var a=0;a<t[o].height;a++)for(var r=0;r<t[o].width;r++)if(0===a||a===t[o].height-1){if(this.checkDoorPath(r+s,a+n,e)){e[a+n][r+s]=new x(r+s,a+n),t[o].doorLocationX=r+s,t[o].doorLocationY=a+n,i++;break t}}else if((0===r||r===t[o].width-1)&&this.checkDoorPath(r+s,a+n,e)){e[a+n][r+s]=new x(r+s,a+n),t[o].doorLocationX=r+s,t[o].doorLocationY=a+n,i++;break t}}return i===t.length?!0:!1},this.popRoom=function(t,e){this.eachTileInRoom(e,function(e,i){t?$(r([e,i])).removeClass("hidden"):$(r([e,i])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,i){for(var o,s,n=this,a=0;a<i.length;a++)i[a].doorLocationX===t&&i[a].doorLocationY===e&&(this.popRoom(!0,i[a]),o=a,s=i[a]);for(var r=0;r<i.length;r++)o!==r&&this.eachTileInRoom(s,function(t,e){i[r].upLeftCornerX===t&&i[r].upLeftCornerY===e&&n.popRoom(!1,i[r])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.lightRoomRogueIn=function(t){for(var e=this,i=0;i<t.length;i++)this.eachTileInRoom(t[i],function(o,s){P.x===o&&P.y===s&&e.popRoom(!0,t[i])})},this.randomRoomsCountRecursion=0,this.randomRooms=function(t){for(var e=this.map.map(l),i=[],o=0,a=0;t>a;){if(o++,o>1e5)return console.log("randomRoomsWhile maxed out"),this.randomRooms(t);var r=Math.floor(Math.random()*(this.columns-n)+n/2),h=Math.floor(Math.random()*(this.rows-n)+n/2),c=Math.floor(Math.random()*(n-s)+s),p=Math.floor(Math.random()*(n-s)+s),u=new y(r,h,c,p);this.roomOverlapCheck(u,e)&&(i.push(u),this.createRoom(u,e),a++)}if(console.log(o),!this.doorsUpdateIfPossible(i,e))return this.randomRooms(t);for(var f=0;f<i.length;f++)this.createRoom(i[f],this.map);this.doorsUpdateIfPossible(i,this.map),this.roomList=l(i)},this.createTerrain=function(){var t=new y(Math.floor(this.columns/2),Math.floor(this.rows/2),this.columns,this.rows);this.createRoom(t,this.map),this.randomRooms(o)},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var i=Math.floor(Math.random()*this.rows),o=Math.floor(Math.random()*this.columns);if(0===this.depth)var s=new R(o,i);else if(1===this.depth)var s=new S(o,i);else if(2===this.depth)var s=new L(o,i);"dot"===this.map[i][o].class&&(this.map[i][o]=s,G.push(s),e++)}},this.placeStairsCount=0,this.placeStairs=function(t){for(var e=0;1>e;){if(this.placeStairsCount++,this.placeStairsCount>1e3){console.log("placeStairs break");break}var i=Math.floor(Math.random()*this.rows),o=Math.floor(Math.random()*this.columns),s=new M(o,i),n=new T(o,i);"dot"===this.map[i][o].class&&("down"===t?(this.map[i][o]=s,e++):"up"===t&&(this.map[i][o]=n,e++))}return[o,i]},this.placeCharacterStairs=function(t){var e=this.placeStairs(t);P.x=e[0],P.y=e[1],this.map[P.y][P.x]=P,this.depth>0?"down"===t?P.standingOn=new M(P.x,P.y):"up"===t&&(P.standingOn=new T(P.x,P.y)):P.standingOn=new v(P.x,P.y)},this.updateDisplay=function(t,e){$(r(t.location())).text(t.text),$(r(t.location())).removeClass(),$(r(t.location())).addClass(t.class+" tile"),2===arguments.length&&($(r(e.location())).removeClass(),$(r(e.location())).addClass(e.class+" tile"),$(r(e.location())).text(e.text))},this.emptyTile=function(t,e){this.map[e][t]=new v(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,i){var o=i.standingOn;i.x+=t,i.y+=e,i.standingOn=this.map[i.y][i.x],this.map[i.y][i.x]=i,this.map[i.y-e][i.x-t]=o,this.updateDisplay(i,o)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),i=this,o=0;Handlebars.registerHelper("columnCounter",function(){return o%i.columns}),Handlebars.registerHelper("rowCounter",function(){return o++,Math.floor(o/i.columns)}),$("#game-window").append(e(i))},this.createPFMatrix=function(t){for(var e=[],i=0;i<this.rows;i++){for(var o=[],s=0;s<this.columns;s++)"wall"===t[i][s].class||"door"===t[i][s].class?o.push(1):o.push(0);e.push(o)}return e},this.initializeMap=function(t){G=[],this.createMap(),this.createTerrain(),this.placeCharacterStairs(t),"down"===t?this.placeStairs("up"):"up"===t&&this.placeStairs("down"),this.createMonsters(a),this.drawMap(),this.darkenRooms(this.roomList),this.lightRoomRogueIn(this.roomList)}},y=function(t,e,i,o,s,n){this.xCenter=t,this.yCenter=e,this.width=i,this.height=o,this.doorLocationX=s||null,this.doorLocationY=n||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},v=function(t,e){this.x=t,this.y=e,this.text="Â·",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};v.prototype.location=function(){return[this.x,this.y]};var g=function(){};g.prototype=new v,g.prototype.constructor=g;var w=function(t,e){v.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};w.prototype=new g,w.prototype.constructor=w;var x=function(t,e){v.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};x.prototype=new g,x.prototype.constructor=x;var M=function(t,e){v.call(this,t,e),this.text=">",this.class="downstairs",this.downStairs=!0,this.inspectText="Stairs leading further into the dungeon. Are you ready for a greater challenge?"};M.prototype=new g,M.prototype.constructor=M,M.prototype.goDown=function(){};var T=function(t,e){v.call(this,t,e),this.text="<",this.class="upstairs",this.upStairs=!0,this.inspectText="Stairs leading up to an easier part of the dungeon."};T.prototype=new g,T.prototype.constructor=T,T.prototype.goUp=function(){};var C=function(t,e){v.call(this,t,e),this.standingOn=new v(t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};C.prototype=new v,C.prototype.constructor=C,C.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},C.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},C.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},C.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,i=100*Math.random();return e>i},C.prototype.combatHandler=function(i){if(this.attackRoll(i)){var o=this.damageRoll();if(i.health-=o,i.health<0){if(p("The "+this.class+" killed the "+i.class+"!"),F.emptyTile(i.x,i.y),i===P)F=new m(t,e),$("#game-window").empty(),$("#game-wrapper").prepend("<div id='dead'>YOU SUCK AND YOU'RE DEAD. lolz<br>You had "+P.gold+" gold.</div>");else if(i.monster){i.removeActor(G);var s=i.lootDrop();F.map[i.y][i.x]=s,F.updateDisplay(i,s)}}else p("The "+this.class+" hit the "+i.class+" for "+Math.round(o)+" damage.")}else p("The "+this.class+" missed the "+i.class+".")};var b=function(t,e){C.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.inspectText="A badass MFer.",this.inventoryOpen=!1,this.inventoryFocus=null,this.tunneling=!1,this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.gold=0,this.inventory={a:null,b:null,c:null,d:null,e:null,f:null,g:null,h:null,i:null,j:null,k:null,l:null,m:null,n:null,o:null,p:null,q:null,r:null,s:null,t:null,u:null,v:null,x:null,y:null,z:null},this.inventory.a=new z(t,e,!1),this.inventory.b=new Y(t,e,!1)};b.prototype=new C,b.prototype.constructor=b,b.prototype.openInventorySlot=function(){for(var t in this.inventory)if(console.log("this.inventory.i: ",this.inventory.i),null===this.inventory[t])return console.log("i: ",t),t;return!1},b.prototype.inventoryHandler=function(t){var e=function(t){t.inventoryFocus=null,t.inventoryOpen=!1,t.drawInventory(),u()};if(!(t>=97&&122>=t))return p("That is not an item"),this.inventoryHandler();var i={97:"a",98:"b",99:"c",100:"d",101:"e",102:"f",103:"g",104:"h",105:"i",106:"j",107:"k",108:"l",109:"m",110:"n",111:"o",112:"p",113:"q",114:"r",115:"s",116:"t",117:"u",118:"v",119:"w",120:"x",121:"x",122:"z"};if(this.inventoryFocus){if(101===t){if(!(this.inventoryFocus instanceof H))return p("That is not equipment"),this.inventoryHandler();this.equip(this.inventoryFocus),p("You have "+this.inventoryFocus+"."),e(this)}else if(117===t){if(!(this.inventoryFocus instanceof H))return p("That is not equipment"),this.inventoryHandler();this.unEquip(this.inventoryFocus),e(this)}}else{var o=i[t];if(console.log(o),null===this.inventory[o])return p("That is not an item"),this.inventoryHandler();p("Do what with the "+this.inventory[o].toString()+"?"),p("drop (d), equip (e), use (u), unequip (u)"),this.inventoryFocus=this.inventory[o],console.log(this.inventoryFocus instanceof H)}},b.prototype.equip=function(t){t.equipped=!0,this.offense+=t.offenseMod,this.maxDamage+=t.damageMod,this.damage+=t.defenseMod},b.prototype.unEquip=function(t){t.equipped=!1,this.offense-=t.offenseMod,this.maxDamage-=t.damageMod,this.defense-=t.defenseMod},b.prototype.checkNextTile=function(t,e){var i=F.map[this.y+e][this.x+t];return i.monster?"monster":i.impassable?"impassable":i.door?"door":i.character?"character":i instanceof N?"gold":i instanceof D?"item":"empty"},b.prototype.keyHandler=function(t){if(81===t&&(this.inventoryOpen=!1,this.inventoryFocus=null),!this.inventoryOpen||this.tunneling){var e,i;if(108===t?(e=1,i=0):104===t?(e=-1,i=0):106===t?(e=0,i=1):107===t?(e=0,i=-1):117===t?(e=1,i=-1):121===t?(e=-1,i=-1):110===t?(e=1,i=1):98===t?(e=-1,i=1):46===t&&(e=0,i=0,this.tunneling=!1),!this.tunneling)if(62===t)this.standingOn.downStairs?d(1):p("You are not standing on descending stairs.");else if(60===t)this.standingOn.upStairs?d(-1):p("You are not standing on ascending stairs.");else if(105===t)this.inventoryOpen=!0,p("------INVENTORY OPEN------"),p("(close with 'Q')"),p("Interact with which item?");else if(82===t)for(var o=0;100>o;o++)u();else 84===t&&(this.tunneling=!0,p("--- Tunnel in which direction? ---"));if(void 0!==e)if("impassable"===this.checkNextTile(e,i)&&this.tunneling){for(var o=0;20>o;o++)u();p("You dig through the wall with your pick."),F.emptyTile(this.x+e,this.y+i),this.tunneling=!1}else if("impassable"===this.checkNextTile(e,i))p("You shall not pass!");else if("monster"===this.checkNextTile(e,i))this.combatHandler(F.map[this.y+i][this.x+e]),u();else if("door"===this.checkNextTile(e,i))F.emptyTile(this.x+e,this.y+i),F.findRoomLightRoom(this.x+e,this.y+i,F.roomList),p("You kick down the door. A loud noise reverberates throughout the dungeon."),u();else if("empty"===this.checkNextTile(e,i))F.updateActor(e,i,this),u();else if("character"===this.checkNextTile(e,i))u();else if("gold"===this.checkNextTile(e,i))this.gold+=F.map[this.y+i][this.x+e].quantity,F.map[this.y+i][this.x+e]=new v(this.x+e,this.y+i),F.updateActor(e,i,this),$("#gold").text("Gold: "+this.gold),u();else if("item"===this.checkNextTile(e,i))if(this.openInventorySlot()){var s=this.openInventorySlot();this.inventory[s]=F.map[this.y+i][this.x+e],F.map[this.y+i][this.x+e]=new v(this.x+e,this.y+i),F.updateActor(e,i,this),u()}else F.updateActor(e,i,this),u()}else this.inventoryHandler(t)},b.prototype.drawInventory=function(){$("#inventory").empty();for(var t in this.inventory)$("#inventory").append(t+": "+this.inventory[t]+"<br>")};var k=function(t,e){C.call(this,t,e),this.monster=!0};k.prototype=new C,k.prototype.constructor=k,k.prototype.lootDrop=function(){return 100*Math.random()<this.treasureQuality?new q(this.x,this.y):new N(this.x,this.y,this.treasureQuality)};var R=function(t,e){k.call(this,t,e),v.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};R.prototype=new k,R.prototype.constructor=R;var S=function(t,e){k.call(this,t,e),v.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/5,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase/2,this.maxDamage=this.maxDamageBase/3,this.treasureQuality=2};S.prototype=new k,S.prototype.constructor=S;var L=function(t,e){k.call(this,t,e),v.call(this,t,e),this.class="goblin",this.text="g",this.inspectText="A short, twisted version of a man.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=3};L.prototype=new k,L.prototype.constructor=L;var D=function(t,e){this.x=t,this.y=e};D.prototype=new v,D.prototype.constructor=D,D.prototype.toString=function(){return this.label};var H=function(t,e,i){D.call(this,t,e),this.x=t,this.y=e,this.equipped=i||!1,this.enchantLevel=0,this.offenseMod=0,this.damageMod=0,this.defenseMod=0};H.prototype=new D,H.prototype.constructor=H,H.prototype.toString=function(){return this.equipped?"equipped "+this.label+" "+this.enchantLevel:this.label+" "+this.enchantLevel};var A=function(t,e,i){H.call(this,t,e,i),this.x=t,this.y=e,this.weapon=!0,this.text="^",this.class="weapon"};A.prototype=new H,A.prototype.constructor=A;var z=function(t,e,i){A.call(this,t,e,i),this.x=t,this.y=e,this.label="Dagger",this.offenseMod=10,this.damageMod=2};z.prototype=new A,z.prototype.constructor=z;var I=function(t,e,i){A.call(this,t,e,i),this.x=t,this.y=e,this.label="Sword",this.offenseMod=5,this.damageMod=6};I.prototype=new A,I.prototype.constructor=I;var B=function(t,e,i){H.call(this,t,e,i),this.x=t,this.y=e,this.text=")",this.class="armor"};B.prototype=new H,B.prototype.constructor=B;var Y=function(t,e,i){B.call(this,t,e,i),this.x=t,this.y=e,this.label="Leather Armor",this.defenseMod=2};Y.prototype=new B,Y.prototype.constructor=Y;var N=function(t,e,i){D.call(this,t,e),this.x=t,this.y=e,this.text="$",this.class="gold",this.quantity=i};N.prototype=new D,N.prototype.constructor=N;var O=function(t,e){D.call(this,t,e),this.x=t,this.y=e,this.text="~",this.class="scroll"};O.prototype=new D,O.prototype.constructor=O;var q=function(t,e){D.call(this,t,e),this.x=t,this.y=e,this.label="Scroll of enchantment"};q.prototype=new D,q.prototype.constructor=q;var F=new m(t,e,0),P=new b(1,1),G=[],X=0,U=new PF.AStarFinder({allowDiagonal:!0}),E=function(){console.log("initialize called"),F.initializeMap("up"),P.drawInventory()};return{GameSpace:GameSpace,initialize:E,rogue:P,clickText:c,currentLevel:F}}(),resizeTiles=function(){var t=.85*$(window).height(),e=.75*$(window).width();$(".tile").width(e/GameSpace.currentLevel.columns),$(".tile").height(t/GameSpace.currentLevel.rows)},resizeText=function(){$(".scale-font").css("font-size",1.05*$(".tile").height())};$(document).on("ready",function(){try{GameSpace.initialize()}catch(t){console.log("initialize failed"),setTimeout(function(){throw t},100)}$(document).keypress(function(t){console.log(t.charCode),GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()}),resizeTiles(),resizeText(),$(window).resize(function(){resizeTiles(),resizeText()})});