var GameSpace=function(){var t=60,e=40,o=52,s=4,n=8,a=function(t){return"#"+String(t[0])+"-"+String(t[1])},r=function(t){var e=t[0],i="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?i+=t[t.length-1]:(i+=t[t.length-2],i+=t[t.length-1]),[Number(e),Number(i)]},h=function E(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?E(t[i]):t[i]);return e},l=function(t){var e=r(t),i=q.map[e[1]][e[0]];$("#"+t).parent().append("<div class='text-popup'>"+i.inspectText+"</br><span class='close-popup'>close</span></div>")},c=function(t){$("#messages").prepend("<p class='a-message'>"+t+"</p>")},p=function(){X++,c("----------- Turn "+X+" -----------");for(var t=0;t<P.length;t++)u(P[t]);F.regen(),$("#hp").text("HP: "+Math.floor(F.health)),F.drawInventory()},u=function(t){var e=q.createPFMatrix(q.map);e[t.y][t.x]=0;var i=new PF.Grid(q.columns,q.rows,e),o=G.findPath(t.x,t.y,F.x,F.y,i);if(o.length>0&&o.length<11){var s=o[1][0]-t.x,n=o[1][1]-t.y;2===o.length?t.combatHandler(F):q.map[o[1][1]][o[1][0]].monster||q.updateActor(s,n,t)}t.regen()},f=function(i){q=new d(t,e,q.depth+i),i>0?q.initializeMap("up"):0>i&&q.initializeMap("down"),resizeTiles(),resizeText()},d=function(t,e,i){this.rows=e,this.columns=t,this.depth=i,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],i=0;i<this.columns;i++)e.push(new y(i,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var i=t.upLeftCornerY+1;i<t.height+t.upLeftCornerY-1;i++)for(var o=t.upLeftCornerX+1;o<t.width+t.upLeftCornerX-1;o++)e(o,i)},this.createRoom=function(t,e){for(var i=t.xCenter-Math.floor(t.width/2),o=t.yCenter-Math.floor(t.height/2),s=0;s<t.height;s++)for(var n=0;n<t.width;n++)0===s||s===t.height-1?e[s+o][n+i]=new g(n+i,s+o):(0===n||n===t.width-1)&&(e[s+o][n+i]=new g(n+i,s+o))},this.roomOverlapCheck=function(t,e){for(var i=t.upLeftCornerY;i<t.upLeftCornerY+t.height;i++)for(var o=t.upLeftCornerX;o<t.upLeftCornerX+t.width;o++)if("wall"===e[i][o].class)return!1;return!0},this.checkDoorPath=function(t,e,i){return"dot"===i[e][t-1].class&&"dot"===i[e][t+1].class?!0:"dot"===i[e-1][t].class&&"dot"===i[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var i=0,o=0;o<t.length;o++){var s=t[o].xCenter-Math.floor(t[o].width/2),n=t[o].yCenter-Math.floor(t[o].height/2);t:for(var a=0;a<t[o].height;a++)for(var r=0;r<t[o].width;r++)if(0===a||a===t[o].height-1){if(this.checkDoorPath(r+s,a+n,e)){e[a+n][r+s]=new w(r+s,a+n),t[o].doorLocationX=r+s,t[o].doorLocationY=a+n,i++;break t}}else if((0===r||r===t[o].width-1)&&this.checkDoorPath(r+s,a+n,e)){e[a+n][r+s]=new w(r+s,a+n),t[o].doorLocationX=r+s,t[o].doorLocationY=a+n,i++;break t}}return i===t.length?!0:!1},this.popRoom=function(t,e){this.eachTileInRoom(e,function(e,i){t?$(a([e,i])).removeClass("hidden"):$(a([e,i])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,i){for(var o,s,n=this,a=0;a<i.length;a++)i[a].doorLocationX===t&&i[a].doorLocationY===e&&(this.popRoom(!0,i[a]),o=a,s=i[a]);for(var r=0;r<i.length;r++)o!==r&&this.eachTileInRoom(s,function(t,e){i[r].upLeftCornerX===t&&i[r].upLeftCornerY===e&&n.popRoom(!1,i[r])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.lightRoomRogueIn=function(t){for(var e=this,i=0;i<t.length;i++)this.eachTileInRoom(t[i],function(o,s){F.x===o&&F.y===s&&e.popRoom(!0,t[i])})},this.randomRoomsCountRecursion=0,this.randomRooms=function(t){for(var e=this.map.map(h),i=[],o=0,a=0;t>a;){if(o++,o>1e5)return console.log("randomRoomsWhile maxed out"),this.randomRooms(t);var r=Math.floor(Math.random()*(this.columns-n)+n/2),l=Math.floor(Math.random()*(this.rows-n)+n/2),c=Math.floor(Math.random()*(n-s)+s),p=Math.floor(Math.random()*(n-s)+s),u=new m(r,l,c,p);this.roomOverlapCheck(u,e)&&(i.push(u),this.createRoom(u,e),a++)}if(console.log(o),!this.doorsUpdateIfPossible(i,e))return this.randomRooms(t);for(var f=0;f<i.length;f++)this.createRoom(i[f],this.map);this.doorsUpdateIfPossible(i,this.map),this.roomList=h(i)},this.createTerrain=function(){var t=new m(Math.floor(this.columns/2),Math.floor(this.rows/2),this.columns,this.rows);this.createRoom(t,this.map),this.randomRooms(o)},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var i=Math.floor(Math.random()*this.rows),o=Math.floor(Math.random()*this.columns);if(0===this.depth)var s=new b(o,i);else if(1===this.depth)var s=new R(o,i);else if(2===this.depth)var s=new S(o,i);"dot"===this.map[i][o].class&&(this.map[i][o]=s,P.push(s),e++)}},this.placeStairsCount=0,this.placeStairs=function(t){for(var e=0;1>e;){if(this.placeStairsCount++,this.placeStairsCount>1e3){console.log("placeStairs break");break}var i=Math.floor(Math.random()*this.rows),o=Math.floor(Math.random()*this.columns),s=new x(o,i),n=new M(o,i);"dot"===this.map[i][o].class&&("down"===t?(this.map[i][o]=s,e++):"up"===t&&(this.map[i][o]=n,e++))}return[o,i]},this.placeCharacterStairs=function(t){var e=this.placeStairs(t);F.x=e[0],F.y=e[1],this.map[F.y][F.x]=F,this.depth>0?"down"===t?F.standingOn=new x(F.x,F.y):"up"===t&&(F.standingOn=new M(F.x,F.y)):F.standingOn=new y(F.x,F.y)},this.updateDisplay=function(t,e){$(a(t.location())).text(t.text),$(a(t.location())).removeClass(),$(a(t.location())).addClass(t.class+" tile"),2===arguments.length&&($(a(e.location())).removeClass(),$(a(e.location())).addClass(e.class+" tile"),$(a(e.location())).text(e.text))},this.emptyTile=function(t,e){this.map[e][t]=new y(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,i){var o=i.standingOn;i.x+=t,i.y+=e,i.standingOn=this.map[i.y][i.x],this.map[i.y][i.x]=i,this.map[i.y-e][i.x-t]=o,this.updateDisplay(i,o)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),i=this,o=0;Handlebars.registerHelper("columnCounter",function(){return o%i.columns}),Handlebars.registerHelper("rowCounter",function(){return o++,Math.floor(o/i.columns)}),$("#game-window").append(e(i))},this.createPFMatrix=function(t){for(var e=[],i=0;i<this.rows;i++){for(var o=[],s=0;s<this.columns;s++)"wall"===t[i][s].class||"door"===t[i][s].class?o.push(1):o.push(0);e.push(o)}return e},this.initializeMap=function(t){P=[],this.createMap(),this.createTerrain(),this.placeCharacterStairs(t),"down"===t?this.placeStairs("up"):"up"===t&&this.placeStairs("down"),this.createMonsters(30),this.map[F.y+1][F.x+1]=new A(1,1),this.drawMap(),this.darkenRooms(this.roomList),this.lightRoomRogueIn(this.roomList)}},m=function(t,e,i,o,s,n){this.xCenter=t,this.yCenter=e,this.width=i,this.height=o,this.doorLocationX=s||null,this.doorLocationY=n||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},y=function(t,e){this.x=t,this.y=e,this.text="Â·",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};y.prototype.location=function(){return[this.x,this.y]};var v=function(){};v.prototype=new y,v.prototype.constructor=v;var g=function(t,e){y.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};g.prototype=new v,g.prototype.constructor=g;var w=function(t,e){y.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};w.prototype=new v,w.prototype.constructor=w;var x=function(t,e){y.call(this,t,e),this.text=">",this.class="downstairs",this.downStairs=!0,this.inspectText="Stairs leading further into the dungeon. Are you ready for a greater challenge?"};x.prototype=new v,x.prototype.constructor=x,x.prototype.goDown=function(){};var M=function(t,e){y.call(this,t,e),this.text="<",this.class="upstairs",this.upStairs=!0,this.inspectText="Stairs leading up to an easier part of the dungeon."};M.prototype=new v,M.prototype.constructor=M,M.prototype.goUp=function(){};var T=function(t,e){y.call(this,t,e),this.standingOn=new y(t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};T.prototype=new y,T.prototype.constructor=T,T.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},T.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},T.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},T.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,i=100*Math.random();return e>i},T.prototype.combatHandler=function(i){if(this.attackRoll(i)){var o=this.damageRoll();if(i.health-=o,i.health<0){if(c("The "+this.class+" killed the "+i.class+"!"),q.emptyTile(i.x,i.y),i===F)q=new d(t,e),$("#game-window").empty(),$("#game-window").append("<div id='dead'<YOU SUCK AND YOU'RE DEAD. lolz</div>");else if(i.monster){i.removeActor(P);var s=i.lootDrop();q.map[i.y][i.x]=s,q.updateDisplay(i,s)}}else c("The "+this.class+" hit the "+i.class+" for "+Math.round(o)+" damage.")}else c("The "+this.class+" missed the "+i.class+".")};var C=function(t,e){T.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.inspectText="A badass MFer.",this.inventoryOpen=!1,this.inventoryFocus=null,this.tunneling=!1,this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.gold=0,this.inventory={a:null,b:null,c:null,d:null,e:null,f:null,g:null,h:null,i:null,j:null,k:null,l:null,m:null,n:null,o:null,p:null,q:null,r:null,s:null,t:null,u:null,v:null,x:null,y:null,z:null},this.inventory.a=new A(t,e,!1),this.inventory.b=new B(t,e,!1)};C.prototype=new T,C.prototype.constructor=C,C.prototype.openInventorySlot=function(){for(var t in this.inventory)if(console.log("this.inventory.i: ",this.inventory.i),null===this.inventory[t])return console.log("i: ",t),t;return!1},C.prototype.inventoryHandler=function(t){var e=function(t){t.inventoryFocus=null,t.inventoryOpen=!1,t.drawInventory(),p()};if(!(t>=97&&122>=t))return c("That is not an item"),this.inventoryHandler();var i={97:"a",98:"b",99:"c",100:"d",101:"e",102:"f",103:"g",104:"h",105:"i",106:"j",107:"k",108:"l",109:"m",110:"n",111:"o",112:"p",113:"q",114:"r",115:"s",116:"t",117:"u",118:"v",119:"w",120:"x",121:"x",122:"z"};if(this.inventoryFocus){if(101===t){if(!(this.inventoryFocus instanceof D))return c("That is not equipment"),this.inventoryHandler();this.equip(this.inventoryFocus),c("You have "+this.inventoryFocus+"."),e(this)}else if(117===t){if(!(this.inventoryFocus instanceof D))return c("That is not equipment"),this.inventoryHandler();this.unEquip(this.inventoryFocus),e(this)}}else{var o=i[t];if(console.log(o),null===this.inventory[o])return c("That is not an item"),this.inventoryHandler();c("Do what with the "+this.inventory[o].toString()+"?"),c("drop (d), equip (e), use (u), unequip (u)"),this.inventoryFocus=this.inventory[o],console.log(this.inventoryFocus instanceof D)}},C.prototype.equip=function(t){t.equipped=!0,this.offense+=t.offenseMod,this.maxDamage+=t.damageMod,this.damage+=t.defenseMod},C.prototype.unEquip=function(t){t.equipped=!1,this.offense-=t.offenseMod,this.maxDamage-=t.damageMod,this.defense-=t.defenseMod},C.prototype.checkNextTile=function(t,e){var i=q.map[this.y+e][this.x+t];return i.monster?"monster":i.impassable?"impassable":i.door?"door":i.character?"character":i instanceof N?"gold":i instanceof L?"item":"empty"},C.prototype.keyHandler=function(t){if(81===t&&(this.inventoryOpen=!1,this.inventoryFocus=null),!this.inventoryOpen||this.tunneling){var e,i;if(108===t?(e=1,i=0):104===t?(e=-1,i=0):106===t?(e=0,i=1):107===t?(e=0,i=-1):117===t?(e=1,i=-1):121===t?(e=-1,i=-1):110===t?(e=1,i=1):98===t?(e=-1,i=1):46===t&&(e=0,i=0,this.tunneling=!1),!this.tunneling)if(62===t)this.standingOn.downStairs?f(1):c("You are not standing on descending stairs.");else if(60===t)this.standingOn.upStairs?f(-1):c("You are not standing on ascending stairs.");else if(105===t)this.inventoryOpen=!0,c("------INVENTORY OPEN------"),c("(close with 'Q')"),c("Interact with which item?");else if(82===t)for(var o=0;100>o;o++)p();else 84===t&&(this.tunneling=!0);if(void 0!==e)if("impassable"===this.checkNextTile(e,i)&&this.tunneling){for(var o=0;20>o;o++)p();c("You dig through the wall with your pick."),q.emptyTile(this.x+e,this.y+i),this.tunneling=!1}else if("impassable"===this.checkNextTile(e,i))c("You shall not pass!");else if("monster"===this.checkNextTile(e,i))this.combatHandler(q.map[this.y+i][this.x+e]),p();else if("door"===this.checkNextTile(e,i))q.emptyTile(this.x+e,this.y+i),q.findRoomLightRoom(this.x+e,this.y+i,q.roomList),c("You kick down the door. A loud noise reverberates throughout the dungeon."),p();else if("empty"===this.checkNextTile(e,i))q.updateActor(e,i,this),p();else if("character"===this.checkNextTile(e,i))p();else if("gold"===this.checkNextTile(e,i))this.gold+=q.map[this.y+i][this.x+e].quantity,q.map[this.y+i][this.x+e]=new y(this.x+e,this.y+i),q.updateActor(e,i,this),p();else if("item"===this.checkNextTile(e,i))if(this.openInventorySlot()){var s=this.openInventorySlot();this.inventory[s]=q.map[this.y+i][this.x+e],q.map[this.y+i][this.x+e]=new y(this.x+e,this.y+i),q.updateActor(e,i,this),p()}else q.updateActor(e,i,this),p()}else this.inventoryHandler(t)},C.prototype.drawInventory=function(){$("#inventory").empty();for(var t in this.inventory)$("#inventory").append(t+": "+this.inventory[t]+"<br>")};var k=function(t,e){T.call(this,t,e),this.monster=!0};k.prototype=new T,k.prototype.constructor=k,k.prototype.lootDrop=function(){return 100*Math.random()<this.treasureQuality?new Y(this.x,this.y):new N(this.x,this.y,this.treasureQuality)};var b=function(t,e){k.call(this,t,e),y.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};b.prototype=new k,b.prototype.constructor=b;var R=function(t,e){k.call(this,t,e),y.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/5,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase/2,this.maxDamage=this.maxDamageBase/3,this.treasureQuality=2};R.prototype=new k,R.prototype.constructor=R;var S=function(t,e){k.call(this,t,e),y.call(this,t,e),this.class="goblin",this.text="g",this.inspectText="A short, twisted version of a man.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=3};S.prototype=new k,S.prototype.constructor=S;var L=function(t,e){this.x=t,this.y=e};L.prototype=new y,L.prototype.constructor=L,L.prototype.toString=function(){return this.label};var D=function(t,e,i){L.call(this,t,e),this.x=t,this.y=e,this.equipped=i||!1,this.enchantLevel=0,this.offenseMod=0,this.damageMod=0,this.defenseMod=0};D.prototype=new L,D.prototype.constructor=D,D.prototype.toString=function(){return this.equipped?"equipped "+this.label+" "+this.enchantLevel:this.label+" "+this.enchantLevel};var H=function(t,e,i){D.call(this,t,e,i),this.x=t,this.y=e,this.weapon=!0,this.text="^",this.class="weapon"};H.prototype=new D,H.prototype.constructor=H;var A=function(t,e,i){H.call(this,t,e,i),this.x=t,this.y=e,this.label="Dagger",this.offenseMod=10,this.damageMod=2};A.prototype=new H,A.prototype.constructor=A;var z=function(t,e,i){H.call(this,t,e,i),this.x=t,this.y=e,this.label="Sword",this.offenseMod=5,this.damageMod=6};z.prototype=new H,z.prototype.constructor=z;var I=function(t,e,i){D.call(this,t,e,i),this.x=t,this.y=e,this.text=")",this.class="armor"};I.prototype=new D,I.prototype.constructor=I;var B=function(t,e,i){I.call(this,t,e,i),this.x=t,this.y=e,this.label="Leather Armor",this.defenseMod=2};B.prototype=new I,B.prototype.constructor=B;var N=function(t,e,i){L.call(this,t,e),this.x=t,this.y=e,this.text="$",this.class="gold",this.quantity=i};N.prototype=new L,N.prototype.constructor=N;var O=function(t,e){L.call(this,t,e),this.x=t,this.y=e,this.text="~",this.text="scroll"};O.prototype=new L,O.prototype.constructor=O;var Y=function(t,e){L.call(this,t,e),this.x=t,this.y=e,this.label="Scroll of enchantment"};Y.prototype=new L,Y.prototype.constructor=Y;var q=new d(t,e,0),F=new C(1,1),P=[],X=0,G=new PF.AStarFinder({allowDiagonal:!0}),U=function(){console.log("initialize called"),q.initializeMap("up"),F.drawInventory()};return{GameSpace:GameSpace,initialize:U,rogue:F,clickText:l,currentLevel:q}}(),resizeTiles=function(){var t=.85*$(window).height(),e=.75*$(window).width();$(".tile").width(e/GameSpace.currentLevel.columns),$(".tile").height(t/GameSpace.currentLevel.rows)},resizeText=function(){$(".scale-font").css("font-size",1.05*$(".tile").height())};$(document).on("ready",function(){try{GameSpace.initialize()}catch(t){console.log("initialize failed"),setTimeout(function(){throw t},100)}$(document).keypress(function(t){console.log(t.charCode),GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()}),resizeTiles(),resizeText(),$(window).resize(function(){resizeTiles(),resizeText()})});