var GameSpace=function(){var t=function(t){return"#"+String(t[0])+"-"+String(t[1])},e=function(t){var e=t[0],o="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?o+=t[t.length-1]:(o+=t[t.length-2],o+=t[t.length-1]),[Number(e),Number(o)]},o=function R(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?R(t[i]):t[i]);return e},s=function(t){var o=e(t),s=v.map[o[1]][o[0]];$("#"+t).parent().append("<div class='text-popup'>"+s.inspectText+"</br><span class='close-popup'>close</span></div>")},a=function(t){$("#messages").prepend("<p>"+t+"</p>")},r=function(){M++,a("------------------- Turn "+M+" -------------------");for(var t=0;t<C.length;t++)n(C[t]);w.regen(),$("#HUD").text("HP: "+Math.floor(w.health))},n=function(t){var e=v.createPFMatrix(v.map);e[t.y][t.x]=0;var o=new PF.Grid(v.columns,v.rows,e),s=k.findPath(t.x,t.y,w.x,w.y,o);if(s.length>0&&s.length<11){var a=s[1][0]-t.x,i=s[1][1]-t.y;2===s.length?t.combatHandler(w):v.map[s[1][1]][s[1][0]].monster||v.updateActor(a,i,t)}t.regen()},h=function(e,s){this.rows=s,this.columns=e,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new l(o,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var s=t.upLeftCornerX+1;s<t.width+t.upLeftCornerX-1;s++)e(s,o)},this.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),s=t.yCenter-Math.floor(t.height/2),a=0;a<t.height;a++)for(var i=0;i<t.width;i++)0===a||a===t.height-1?e[a+s][i+o]=new u(i+o,a+s):(0===i||i===t.width-1)&&(e[a+s][i+o]=new u(i+o,a+s))},this.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var s=t.upLeftCornerX;s<t.upLeftCornerX+t.width;s++)if("wall"===e[o][s].class)return!1;return!0},this.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var o=0,s=0;s<t.length;s++){var a=t[s].xCenter-Math.floor(t[s].width/2),i=t[s].yCenter-Math.floor(t[s].height/2);t:for(var r=0;r<t[s].height;r++)for(var n=0;n<t[s].width;n++)if(0===r||r===t[s].height-1){if(this.checkDoorPath(n+a,r+i,e)){e[r+i][n+a]=new m(n+a,r+i),t[s].doorLocationX=n+a,t[s].doorLocationY=r+i,o++;break t}}else if((0===n||n===t[s].width-1)&&this.checkDoorPath(n+a,r+i,e)){e[r+i][n+a]=new m(n+a,r+i),t[s].doorLocationX=n+a,t[s].doorLocationY=r+i,o++;break t}}return o===t.length?!0:!1},this.popRoom=function(e,o){this.eachTileInRoom(o,function(o,s){e?$(t([o,s])).removeClass("hidden"):$(t([o,s])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,o){for(var s,a,i=this,r=0;r<o.length;r++)o[r].doorLocationX===t&&o[r].doorLocationY===e&&(this.popRoom(!0,o[r]),s=r,a=o[r]);for(var n=0;n<o.length;n++)s!==n&&this.eachTileInRoom(a,function(t,e){o[n].upLeftCornerX===t&&o[n].upLeftCornerY===e&&i.popRoom(!1,o[n])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.randomRooms=function(t){for(var e=4,s=11,a=this.map.map(o),i=[],r=0;t>r;){var n=Math.floor(Math.random()*(this.columns-s)+s/2),h=Math.floor(Math.random()*(this.rows-s)+s/2),l=Math.floor(Math.random()*(s-e)+e),p=Math.floor(Math.random()*(s-e)+e),u=new c(n,h,l,p);this.roomOverlapCheck(u,a)&&(i.push(u),this.createRoom(u,a),r++)}if(!this.doorsUpdateIfPossible(i,a))return this.randomRooms(t);for(var m=0;m<i.length;m++)this.createRoom(i[m],this.map);this.doorsUpdateIfPossible(i,this.map),this.roomList=o(i)},this.createTerrain=function(){var t=new c(Math.floor(v.columns/2),Math.floor(v.rows/2),v.columns,v.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*v.rows),s=Math.floor(Math.random()*v.columns),a=new y(s,o);"dot"===v.map[o][s].class&&(v.map[o][s]=a,C.push(a),e++)}},this.placeCharacter=function(){this.map[w.y][w.x]=w},this.updateDisplay=function(e,o){$(t(e.location())).text(e.text),$(t(e.location())).removeClass(),$(t(e.location())).addClass(e.class+" tile"),2===arguments.length&&($(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),$(t(o.location())).text(o.text))},this.emptyTile=function(t,e){this.map[e][t]=new l(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,o){var s=new l(o.x,o.y);o.x+=t,o.y+=e,this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=s,this.updateDisplay(o,s)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,s=0;Handlebars.registerHelper("columnCounter",function(){return s%o.columns}),Handlebars.registerHelper("rowCounter",function(){return s++,Math.floor(s/o.columns)}),$("#game-window").append(e(o))},this.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var s=[],a=0;a<this.columns;a++)"wall"===t[o][a].class||"door"===t[o][a].class?s.push(1):s.push(0);e.push(s)}return e}},c=function(t,e,o,s,a,i){this.xCenter=t,this.yCenter=e,this.width=o,this.height=s,this.doorLocationX=a||null,this.doorLocationY=i||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},l=function(t,e){this.x=t,this.y=e,this.text=".",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};l.prototype.location=function(){return[this.x,this.y]};var p=function(){};p.prototype=new l,p.prototype.constructor=p;var u=function(t,e){l.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};u.prototype=new p,u.prototype.constructor=u;var m=function(t,e){l.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};m.prototype=new p,m.prototype.constructor=m;var f=function(t,e){l.call(this,t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};f.prototype=new l,f.prototype.constructor=f,f.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},f.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},f.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},f.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,o=100*Math.random();return e>o},f.prototype.combatHandler=function(t){if(this.attackRoll(t)){var e=this.damageRoll();t.health-=e,t.health<0?(a("The "+this.class+" killed the "+t.class+"!"),v.emptyTile(t.x,t.y),t===w||t.monster&&t.removeActor(C)):a("The "+this.class+" hit the "+t.class+" for "+Math.round(e)+" damage.")}else a("The "+this.class+" missed the "+t.class+".")};var d=function(t,e){l.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.inspectText="A badass mother fucker.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase};d.prototype=new f,d.prototype.constructor=d,d.prototype.checkNextTile=function(t,e){var o=v.map[this.y+e][this.x+t];return o.monster?"monster":o.impassable?"impassable":o.door?"door":o.character?"character":"empty"},d.prototype.keyHandler=function(t){var e,o;108===t?(e=1,o=0):104===t?(e=-1,o=0):106===t?(e=0,o=1):107===t?(e=0,o=-1):117===t?(e=1,o=-1):121===t?(e=-1,o=-1):110===t?(e=1,o=1):98===t?(e=-1,o=1):46===t&&(e=0,o=0),"impassable"===this.checkNextTile(e,o)?a("You shall not pass!"):"monster"===this.checkNextTile(e,o)?(this.combatHandler(v.map[this.y+o][this.x+e]),r()):"door"===this.checkNextTile(e,o)?(v.emptyTile(this.x+e,this.y+o),v.findRoomLightRoom(this.x+e,this.y+o,v.roomList),a("You kick down the door. A loud noise reverberates throughout the dungeon."),r()):"empty"===this.checkNextTile(e,o)?(v.updateActor(e,o,this),r()):"character"===this.checkNextTile(e,o)&&r()};var x=function(){this.monster=!0};x.prototype=new f,x.prototype.constructor=x;var y=function(t,e){l.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};y.prototype=new x,y.prototype.constructor=y;var g=function(t,e){l.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/8,this.health=this.maxHealth,this.offense=this.offenseBase/8,this.defense=this.defenseBase/8,this.maxDamage=this.maxDamageBase/8,this.treasureQuality=2};g.prototype=new x,g.prototype.constructor=g;var v=new h(60,40),w=new d(1,1),C=[],M=0,k=new PF.AStarFinder({allowDiagonal:!0}),L=function(){v.createMap(),v.createTerrain(),v.placeCharacter(),v.createMonsters(30),v.drawMap(),v.darkenRooms(v.roomList)};return{GameSpace:GameSpace,initialize:L,rogue:w,clickText:s,currentLevel:v}}();$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()})});