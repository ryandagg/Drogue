var GameSpace=function(){var t=function(t){return"#column-"+String(t[0])+"-row-"+String(t[1])},o=function(t){$("#messages").append("<p>"+t+"</p>")},e=function(t,o){var e=f.map[m.y+o][m.x+t];return e.monster?"monster":e.impassable?"impassable":e.door?"door":"empty"},r=function(t){var r,i;108===t?(r=1,i=0):104===t?(r=-1,i=0):106===t?(r=0,i=1):107===t?(r=0,i=-1):117===t?(r=1,i=-1):121===t?(r=-1,i=-1):110===t?(r=1,i=1):98===t&&(r=-1,i=1),"impassable"===e(r,i)?o("You shall not pass!"):"monster"===e(r,i)?f.updateRogue(r,i):"dot"===e(r,i)?f.updateRogue(r,i):"door"===e(r,i)?(f.emptyTile(m.x+r,m.y+i),f.findRoomLightRoom(m.x+r,m.y+i,f.roomList),o("You kick down the door. A loud noise reverberates throughout the dungeon.")):"empty"===e(r,i)&&f.updateRogue(r,i)},i=function(o,e){this.rows=e,this.columns=o,this.map=[],this.createMap=function(){for(var t=0;t<this.rows;t++){for(var o=[],e=0;e<this.columns;e++)o.push(new a(e,t));this.map.push(o)}},this.cloneMap=function(){for(var t=[],o=0;o<this.map.length;o++)t.push(this.map[o].clone());return t},this.eachTileInRoom=function(t,o){for(var e=t.upLeftCornerY+1;e<t.height+t.upLeftCornerY-1;e++)for(var r=t.upLeftCornerX+1;r<t.width+t.upLeftCornerX-1;r++)o(r,e)},this.createRoom=function(t,o){for(var e=t.xCenter-Math.floor(t.width/2),r=t.yCenter-Math.floor(t.height/2),i=0;i<t.height;i++)for(var s=0;s<t.width;s++)0===i||i===t.height-1?o[i+r][s+e]=new h(s+e,i+r):(0===s||s===t.width-1)&&(o[i+r][s+e]=new h(s+e,i+r))},this.roomOverlapCheck=function(t,o){for(var e=t.upLeftCornerY;e<t.upLeftCornerY+t.height;e++)for(var r=t.upLeftCornerX;r<t.upLeftCornerX+t.width;r++)if("wall"===o[e][r].class)return!1;return!0},this.checkDoorPath=function(t,o,e){return"dot"===e[o][t-1].class&&"dot"===e[o][t+1].class?!0:"dot"===e[o-1][t].class&&"dot"===e[o+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,o){for(var e=0,r=0;r<t.length;r++){var i=t[r].xCenter-Math.floor(t[r].width/2),s=t[r].yCenter-Math.floor(t[r].height/2);t:for(var a=0;a<t[r].height;a++)for(var n=0;n<t[r].width;n++)if(0===a||a===t[r].height-1){if(this.checkDoorPath(n+i,a+s,o)){o[a+s][n+i]=new c(n+i,a+s),t[r].doorLocationX=n+i,t[r].doorLocationY=a+s,e++;break t}}else if((0===n||n===t[r].width-1)&&this.checkDoorPath(n+i,a+s,o)){o[a+s][n+i]=new c(n+i,a+s),t[r].doorLocationX=n+i,t[r].doorLocationY=a+s,e++;break t}}return e===t.length?!0:!1},this.roomList=null,this.popRoom=function(o,e){this.eachTileInRoom(e,function(e,r){o?$(t([e,r])).removeClass("hidden"):$(t([e,r])).addClass("hidden")})},this.findRoomLightRoom=function(t,o,e){for(var r,i,s=this,a=0;a<e.length;a++)e[a].doorLocationX===t&&e[a].doorLocationY===o&&(this.popRoom(!0,e[a]),r=a,i=e[a]);for(var n=0;n<e.length;n++)r!==n&&this.eachTileInRoom(i,function(t,o){e[n].xCenter===t&&e[n].yCenter===o&&(console.log(e[n]),console.log("x: "+t),console.log("y: "+o),s.popRoom(!1,e[n]))})},this.darkenRooms=function(t){for(var o=0;o<t.length;o++)this.popRoom(!1,t[o])},this.randomRooms=function(t){for(var o=4,e=11,r=this.cloneMap(),i=[],a=0;t>a;){var n=Math.floor(Math.random()*(this.columns-e)+e/2),h=Math.floor(Math.random()*(this.rows-e)+e/2),c=Math.floor(Math.random()*(e-o)+o),l=Math.floor(Math.random()*(e-o)+o),p=new s(n,h,c,l);this.roomOverlapCheck(p,r)&&(i.push(p),this.createRoom(p,r),a++)}if(!this.doorsUpdateIfPossible(i,r))return this.randomRooms(t);for(var u=0;u<i.length;u++)this.createRoom(i[u],this.map);this.doorsUpdateIfPossible(i,this.map),this.roomList=i.clone()},this.createTerrain=function(){var t=new s(Math.floor(f.columns/2),Math.floor(f.rows/2),f.columns,f.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.createMonsters=function(t){for(var o=0;t>o;){var e=Math.floor(Math.random()*f.rows),r=Math.floor(Math.random()*f.columns),i=new u(r,e);"dot"===f.map[e][r].class&&(f.map[e][r]=i,o++)}},this.placeCharacter=function(){this.map[m.y][m.x]=m},this.updateDisplay=function(o,e){$(t(o.location())).text(o.text),$(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),2===arguments.length&&($(t(e.location())).addClass(e.class+" tile"),$(t(e.location())).removeClass(),$(t(e.location())).text(e.text))},this.emptyTile=function(t,o){this.map[o][t]=new a(t,o),this.updateDisplay(this.map[o][t])},this.updateRogue=function(t,o){var e=new a(m.x,m.y);m.x+=t,m.y+=o,this.map[m.y][m.x]=m,this.map[m.y-o][m.x-t]=e,this.updateDisplay(m,e)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),o=Handlebars.compile(t),e=this,r=0;Handlebars.registerHelper("columnCounter",function(){return r%e.columns}),Handlebars.registerHelper("rowCounter",function(){return r++,Math.floor(r/e.columns)}),$("#game-window").append(o(e))}},s=function(t,o,e,r,i,s){this.xCenter=t,this.yCenter=o,this.width=e,this.height=r,this.doorLocationX=i||null,this.doorLocationY=s||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},a=function(t,o){this.x=t,this.y=o,this.text=".",this.class="dot",this.impassable=!1};a.prototype.location=function(){return[this.x,this.y]};var n=function(){};n.prototype=new a,n.prototype.constructor=n;var h=function(t,o){a.call(this,t,o),this.text="#",this.class="wall",this.impassable=!0};h.prototype=new n,h.prototype.constructor=h;var c=function(t,o){a.call(this,t,o),this.text="+",this.class="door",this.door=!0};c.prototype=new n,c.prototype.constructor=c;var l=function(t,o){a.call(this,t,o),this.text="@",this.class="character",this.health=100,this.attack=100,this.defense=100,this.damage=100};l.prototype=new a,l.prototype.constructor=l;var p=function(){this.healthBase=100,this.attackBase=100,this.damageBase=100,this.defenseBase=100,this.monster=!0};p.prototype.attack=function(){},p.prototype=new a,p.prototype.constructor=p;var u=function(t,o){a.call(this,t,o),this.class="rat",this.text="r",this.health=this.healthBase/10,this.attack=this.attackBase/10,this.defense=this.defenseBase/10,this.damage=this.damageBase/10,this.treasureQuality=1};u.prototype=new p,u.prototype.constructor=u;var f=new i(60,40),m=new l(1,1),d=function(){f.createMap(),f.createTerrain(),f.placeCharacter(),f.createMonsters(30),f.drawMap(),f.darkenRooms(f.roomList)};return{initialize:d,rogue:m,currentLevel:f,keyHandler:r}}();Object.prototype.clone=function(){var t=this instanceof Array?[]:{};for(i in this)"clone"!=i&&(t[i]=this[i]&&"object"==typeof this[i]?this[i].clone():this[i]);return t},$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.keyHandler(t.charCode)})});