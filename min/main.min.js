var GameSpace=function(){var t=function(t){return"#column-"+String(t[0])+"-row-"+String(t[1])},o=function(t){$("#messages").append("<p>"+t+"</p>")},e=function(t){var o=w.createPFMatrix(w.map);o[t.y][t.x]=0;var e=new PF.Grid(w.columns,w.rows,o),r=M.findPath(t.x,t.y,y.x,y.y,e);if(r.length>0){var a=r[1][0],s=r[1][1];console.log("monster:",t.x,t.y),console.log("horz: "+a,"vert: "+s)}},r=function(){g++;for(var t=0;t<v.length;t++)e(v[t])},a=function(t,o){var e=w.map[y.y+o][y.x+t];return e.monster?"monster":e.impassable?"impassable":e.door?"door":"empty"},s=function(t){var e,s;108===t?(e=1,s=0):104===t?(e=-1,s=0):106===t?(e=0,s=1):107===t?(e=0,s=-1):117===t?(e=1,s=-1):121===t?(e=-1,s=-1):110===t?(e=1,s=1):98===t&&(e=-1,s=1),"impassable"===a(e,s)?o("You shall not pass!"):"monster"===a(e,s)?(w.updateRogue(e,s),r()):"door"===a(e,s)?(w.emptyTile(y.x+e,y.y+s),w.findRoomLightRoom(y.x+e,y.y+s,w.roomList),o("You kick down the door. A loud noise reverberates throughout the dungeon."),r()):"empty"===a(e,s)&&(w.updateRogue(e,s),r())},i=function(o,e){this.rows=e,this.columns=o,this.map=[],this.createMap=function(){for(var t=0;t<this.rows;t++){for(var o=[],e=0;e<this.columns;e++)o.push(new h(e,t));this.map.push(o)}},this.cloneMap=function(){for(var t=[],o=0;o<this.map.length;o++)t.push(this.map[o].clone());return t},this.eachTileInRoom=function(t,o){for(var e=t.upLeftCornerY+1;e<t.height+t.upLeftCornerY-1;e++)for(var r=t.upLeftCornerX+1;r<t.width+t.upLeftCornerX-1;r++)o(r,e)},this.createRoom=function(t,o){for(var e=t.xCenter-Math.floor(t.width/2),r=t.yCenter-Math.floor(t.height/2),a=0;a<t.height;a++)for(var s=0;s<t.width;s++)0===a||a===t.height-1?o[a+r][s+e]=new l(s+e,a+r):(0===s||s===t.width-1)&&(o[a+r][s+e]=new l(s+e,a+r))},this.roomOverlapCheck=function(t,o){for(var e=t.upLeftCornerY;e<t.upLeftCornerY+t.height;e++)for(var r=t.upLeftCornerX;r<t.upLeftCornerX+t.width;r++)if("wall"===o[e][r].class)return!1;return!0},this.checkDoorPath=function(t,o,e){return"dot"===e[o][t-1].class&&"dot"===e[o][t+1].class?!0:"dot"===e[o-1][t].class&&"dot"===e[o+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,o){for(var e=0,r=0;r<t.length;r++){var a=t[r].xCenter-Math.floor(t[r].width/2),s=t[r].yCenter-Math.floor(t[r].height/2);t:for(var i=0;i<t[r].height;i++)for(var n=0;n<t[r].width;n++)if(0===i||i===t[r].height-1){if(this.checkDoorPath(n+a,i+s,o)){o[i+s][n+a]=new p(n+a,i+s),t[r].doorLocationX=n+a,t[r].doorLocationY=i+s,e++;break t}}else if((0===n||n===t[r].width-1)&&this.checkDoorPath(n+a,i+s,o)){o[i+s][n+a]=new p(n+a,i+s),t[r].doorLocationX=n+a,t[r].doorLocationY=i+s,e++;break t}}return e===t.length?!0:!1},this.roomList=null,this.popRoom=function(o,e){this.eachTileInRoom(e,function(e,r){o?$(t([e,r])).removeClass("hidden"):$(t([e,r])).addClass("hidden")})},this.findRoomLightRoom=function(t,o,e){for(var r,a,s=this,i=0;i<e.length;i++)e[i].doorLocationX===t&&e[i].doorLocationY===o&&(this.popRoom(!0,e[i]),r=i,a=e[i]);for(var n=0;n<e.length;n++)r!==n&&this.eachTileInRoom(a,function(t,o){e[n].upLeftCornerX===t&&e[n].upLeftCornerY===o&&s.popRoom(!1,e[n])})},this.darkenRooms=function(t){for(var o=0;o<t.length;o++)this.popRoom(!1,t[o])},this.randomRooms=function(t){for(var o=4,e=11,r=this.cloneMap(),a=[],s=0;t>s;){var i=Math.floor(Math.random()*(this.columns-e)+e/2),h=Math.floor(Math.random()*(this.rows-e)+e/2),c=Math.floor(Math.random()*(e-o)+o),l=Math.floor(Math.random()*(e-o)+o),p=new n(i,h,c,l);this.roomOverlapCheck(p,r)&&(a.push(p),this.createRoom(p,r),s++)}if(!this.doorsUpdateIfPossible(a,r))return this.randomRooms(t);for(var u=0;u<a.length;u++)this.createRoom(a[u],this.map);this.doorsUpdateIfPossible(a,this.map),this.roomList=a.clone()},this.createTerrain=function(){var t=new n(Math.floor(w.columns/2),Math.floor(w.rows/2),w.columns,w.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var o=0;t>o;){var e=Math.floor(Math.random()*w.rows),r=Math.floor(Math.random()*w.columns),a=new m(r,e);"dot"===w.map[e][r].class&&(w.map[e][r]=a,v.push(a),o++)}},this.placeCharacter=function(){this.map[y.y][y.x]=y},this.updateDisplay=function(o,e){$(t(o.location())).text(o.text),$(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),2===arguments.length&&($(t(e.location())).addClass(e.class+" tile"),$(t(e.location())).removeClass(),$(t(e.location())).text(e.text))},this.emptyTile=function(t,o){this.map[o][t]=new h(t,o),this.updateDisplay(this.map[o][t])},this.updateRogue=function(t,o){var e=new h(y.x,y.y);y.x+=t,y.y+=o,this.map[y.y][y.x]=y,this.map[y.y-o][y.x-t]=e,this.updateDisplay(y,e)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),o=Handlebars.compile(t),e=this,r=0;Handlebars.registerHelper("columnCounter",function(){return r%e.columns}),Handlebars.registerHelper("rowCounter",function(){return r++,Math.floor(r/e.columns)}),$("#game-window").append(o(e))},this.createPFMatrix=function(t){for(var o=[],e=0;e<this.rows;e++){for(var r=[],a=0;a<this.columns;a++)"wall"===t[e][a].class||"door"===t[e][a].class?r.push(1):r.push(0);o.push(r)}return o}},n=function(t,o,e,r,a,s){this.xCenter=t,this.yCenter=o,this.width=e,this.height=r,this.doorLocationX=a||null,this.doorLocationY=s||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},h=function(t,o){this.x=t,this.y=o,this.text=".",this.class="dot",this.impassable=!1};h.prototype.location=function(){return[this.x,this.y]};var c=function(){};c.prototype=new h,c.prototype.constructor=c;var l=function(t,o){h.call(this,t,o),this.text="#",this.class="wall",this.impassable=!0};l.prototype=new c,l.prototype.constructor=l;var p=function(t,o){h.call(this,t,o),this.text="+",this.class="door",this.door=!0};p.prototype=new c,p.prototype.constructor=p;var u=function(t,o){h.call(this,t,o),this.text="@",this.class="character",this.health=100,this.attack=100,this.defense=100,this.damage=100};u.prototype=new h,u.prototype.constructor=u;var f=function(){this.healthBase=100,this.attackBase=100,this.damageBase=100,this.defenseBase=100,this.monster=!0};f.prototype.attack=function(){},f.prototype=new h,f.prototype.constructor=f;var m=function(t,o){h.call(this,t,o),this.class="rat",this.text="r",this.health=this.healthBase/10,this.attack=this.attackBase/10,this.defense=this.defenseBase/10,this.damage=this.damageBase/10,this.treasureQuality=1};m.prototype=new f,m.prototype.constructor=m;var d=function(t,o){h.call(this,t,o),this.class="kobold",this.text="k",this.health=this.healthBase/8,this.attack=this.attackBase/8,this.defense=this.defenseBase/8,this.damage=this.damageBase/8,this.treasureQuality=2};d.prototype=new f,d.prototype.constructor=d;var w=new i(60,40),y=new u(1,1),v=[],g=0,M=new PF.AStarFinder({allowDiagonal:!0}),C=function(){w.createMap(),w.createTerrain(),w.placeCharacter(),w.createMonsters(30),w.drawMap(),w.darkenRooms(w.roomList)};return{GameSpace:GameSpace,initialize:C,keyHandler:s}}();Object.prototype.clone=function(){var t=this instanceof Array?[]:{};for(i in this)"clone"!=i&&(t[i]=this[i]&&"object"==typeof this[i]?this[i].clone():this[i]);return t},$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.keyHandler(t.charCode)})});