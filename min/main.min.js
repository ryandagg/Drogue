var GameSpace=function(){var t=function(t){return"#"+String(t[0])+"-"+String(t[1])},e=function(t){var e=t[0],o="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?o+=t[t.length-1]:(o+=t[t.length-2],o+=t[t.length-1]),[Number(e),Number(o)]},o=function B(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?B(t[i]):t[i]);return e},a=function(t){var o=e(t),a=R.map[o[1]][o[0]];$("#"+t).parent().append("<div class='text-popup'>"+a.inspectText+"</br><span class='close-popup'>close</span></div>")},s=function(t){$("#messages").prepend("<p>"+t+"</p>")},r=function(){H++,s("------------------- Turn "+H+" -------------------");for(var t=0;t<T.length;t++)l(T[t]);c(b)},n=function(t,e){var o=R.map[b.y+e][b.x+t];return o.monster?"monster":o.impassable?"impassable":o.door?"door":o.character?"character":"empty"},h=function(t){var e,o;108===t?(e=1,o=0):104===t?(e=-1,o=0):106===t?(e=0,o=1):107===t?(e=0,o=-1):117===t?(e=1,o=-1):121===t?(e=-1,o=-1):110===t?(e=1,o=1):98===t?(e=-1,o=1):46===t&&(e=0,o=0),"impassable"===n(e,o)?s("You shall not pass!"):"monster"===n(e,o)?(f(b,R.map[b.y+o][b.x+e]),r()):"door"===n(e,o)?(R.emptyTile(b.x+e,b.y+o),R.findRoomLightRoom(b.x+e,b.y+o,R.roomList),s("You kick down the door. A loud noise reverberates throughout the dungeon."),r()):"empty"===n(e,o)?(R.updateActor(e,o,b),r()):"character"===n(e,o)&&r()},c=function(t){t.health<t.maxHealth&&(t.health+=t.maxHealth/t.regenRate)},l=function(t){var e=R.createPFMatrix(R.map);e[t.y][t.x]=0;var o=new PF.Grid(R.columns,R.rows,e),a=D.findPath(t.x,t.y,b.x,b.y,o);if(a.length>0&&a.length<11){var s=a[1][0]-t.x,r=a[1][1]-t.y;2===a.length?f(t,b):R.map[a[1][1]][a[1][0]].monster||R.updateActor(s,r,t)}c(t)},p=function(t,e){for(var o=0;o<e.length;o++)if(e[o].x===t.x&&e[o].y===t.y){e.splice(o,1);break}},u=function(t){for(var e=0,o=0;o<t.damClump;o++)e+=Math.random()*t.maxDamage/t.damClump;return e},m=function(t,e){var o=t.offense-e.defense+50,a=100*Math.random();return o>a},f=function(t,e){if(m(t,e)){var o=u(t);e.health-=o,e.health<0?(s("The "+t.class+" killed the "+e.class+"!"),R.emptyTile(e.x,e.y),e===b||e.monster&&p(e,T)):s("The "+t.class+" hit the "+e.class+" for "+Math.round(o)+" damage.")}else s("The "+t.class+" missed the "+e.class+".")},d=function(e,a){this.rows=a,this.columns=e,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new x(o,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var a=t.upLeftCornerX+1;a<t.width+t.upLeftCornerX-1;a++)e(a,o)},this.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),a=t.yCenter-Math.floor(t.height/2),s=0;s<t.height;s++)for(var r=0;r<t.width;r++)0===s||s===t.height-1?e[s+a][r+o]=new y(r+o,s+a):(0===r||r===t.width-1)&&(e[s+a][r+o]=new y(r+o,s+a))},this.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var a=t.upLeftCornerX;a<t.upLeftCornerX+t.width;a++)if("wall"===e[o][a].class)return!1;return!0},this.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var o=0,a=0;a<t.length;a++){var s=t[a].xCenter-Math.floor(t[a].width/2),r=t[a].yCenter-Math.floor(t[a].height/2);t:for(var i=0;i<t[a].height;i++)for(var n=0;n<t[a].width;n++)if(0===i||i===t[a].height-1){if(this.checkDoorPath(n+s,i+r,e)){e[i+r][n+s]=new g(n+s,i+r),t[a].doorLocationX=n+s,t[a].doorLocationY=i+r,o++;break t}}else if((0===n||n===t[a].width-1)&&this.checkDoorPath(n+s,i+r,e)){e[i+r][n+s]=new g(n+s,i+r),t[a].doorLocationX=n+s,t[a].doorLocationY=i+r,o++;break t}}return o===t.length?!0:!1},this.popRoom=function(e,o){this.eachTileInRoom(o,function(o,a){e?$(t([o,a])).removeClass("hidden"):$(t([o,a])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,o){for(var a,s,r=this,i=0;i<o.length;i++)o[i].doorLocationX===t&&o[i].doorLocationY===e&&(this.popRoom(!0,o[i]),a=i,s=o[i]);for(var n=0;n<o.length;n++)a!==n&&this.eachTileInRoom(s,function(t,e){o[n].upLeftCornerX===t&&o[n].upLeftCornerY===e&&r.popRoom(!1,o[n])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.randomRooms=function(t){for(var e=4,a=11,s=this.map.map(o),r=[],i=0;t>i;){var n=Math.floor(Math.random()*(this.columns-a)+a/2),h=Math.floor(Math.random()*(this.rows-a)+a/2),c=Math.floor(Math.random()*(a-e)+e),l=Math.floor(Math.random()*(a-e)+e),p=new w(n,h,c,l);this.roomOverlapCheck(p,s)&&(r.push(p),this.createRoom(p,s),i++)}if(!this.doorsUpdateIfPossible(r,s))return this.randomRooms(t);for(var u=0;u<r.length;u++)this.createRoom(r[u],this.map);this.doorsUpdateIfPossible(r,this.map),this.roomList=o(r)},this.createTerrain=function(){var t=new w(Math.floor(R.columns/2),Math.floor(R.rows/2),R.columns,R.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*R.rows),a=Math.floor(Math.random()*R.columns),s=new L(a,o);"dot"===R.map[o][a].class&&(R.map[o][a]=s,T.push(s),e++)}},this.placeCharacter=function(){this.map[b.y][b.x]=b},this.updateDisplay=function(e,o){$(t(e.location())).text(e.text),$(t(e.location())).removeClass(),$(t(e.location())).addClass(e.class+" tile"),2===arguments.length&&($(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),$(t(o.location())).text(o.text))},this.emptyTile=function(t,e){this.map[e][t]=new x(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,o){var a=new x(o.x,o.y);o.x+=t,o.y+=e,this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=a,this.updateDisplay(o,a)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,a=0;Handlebars.registerHelper("columnCounter",function(){return a%o.columns}),Handlebars.registerHelper("rowCounter",function(){return a++,Math.floor(a/o.columns)}),$("#game-window").append(e(o))},this.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var a=[],s=0;s<this.columns;s++)"wall"===t[o][s].class||"door"===t[o][s].class?a.push(1):a.push(0);e.push(a)}return e}},w=function(t,e,o,a,s,r){this.xCenter=t,this.yCenter=e,this.width=o,this.height=a,this.doorLocationX=s||null,this.doorLocationY=r||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},x=function(t,e){this.x=t,this.y=e,this.text=".",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};x.prototype.location=function(){return[this.x,this.y]};var v=function(){};v.prototype=new x,v.prototype.constructor=v;var y=function(t,e){x.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};y.prototype=new v,y.prototype.constructor=y;var g=function(t,e){x.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};g.prototype=new v,g.prototype.constructor=g;var C=function(t,e){x.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.maxHealth=100,this.health=this.maxHealth,this.offense=10,this.defense=10,this.maxDamage=10,this.damClump=3,this.inspectText="A badass MFer."};C.prototype=new x,C.prototype.constructor=C;var M=function(){this.healthBase=100,this.offenseBase=100,this.maxDamageBase=100,this.defenseBase=100,this.damClump=3,this.regenRate=400,this.monster=!0,this.moveSpeed=1};M.prototype=new x,M.prototype.constructor=M;var L=function(t,e){x.call(this,t,e),this.class="rat",this.text="r",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase/10,this.defense=this.defenseBase/10,this.maxDamage=this.maxDamageBase/10,this.treasureQuality=1,this.inspectText="A enormous, mangy rat. It looks hungry."};L.prototype=new M,L.prototype.constructor=L;var k=function(t,e){x.call(this,t,e),this.class="kobold",this.text="k",this.maxHealth=this.healthBase/8,this.health=this.maxHealth,this.offense=this.offenseBase/8,this.defense=this.defenseBase/8,this.maxDamage=this.maxDamageBase/8,this.treasureQuality=2,this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you."};k.prototype=new M,k.prototype.constructor=k;var R=new d(60,40),b=new C(1,1),T=[],H=0,D=new PF.AStarFinder({allowDiagonal:!0}),A=function(){R.createMap(),R.createTerrain(),R.placeCharacter(),R.createMonsters(30),R.drawMap(),R.darkenRooms(R.roomList)};return{GameSpace:GameSpace,initialize:A,keyHandler:h,rogue:b,clickText:a,currentLevel:R}}();$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()})});