var GameSpace=function(){var t=60,e=40,o=52,s=4,a=8,n=function(t){return"#"+String(t[0])+"-"+String(t[1])},r=function(t){var e=t[0],o="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?o+=t[t.length-1]:(o+=t[t.length-2],o+=t[t.length-1]),[Number(e),Number(o)]},h=function X(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?X(t[i]):t[i]);return e},c=function(t){var e=r(t),o=A.map[e[1]][e[0]];$("#"+t).parent().append("<div class='text-popup'>"+o.inspectText+"</br><span class='close-popup'>close</span></div>")},l=function(t){$("#messages").prepend("<p class='a-message'>"+t+"</p>")},p=function(){N++,l("------------------- Turn "+N+" -------------------");for(var t=0;t<I.length;t++)u(I[t]);Y.regen(),$("#HUD").text("HP: "+Math.floor(Y.health))},u=function(t){var e=A.createPFMatrix(A.map);e[t.y][t.x]=0;var o=new PF.Grid(A.columns,A.rows,e),s=P.findPath(t.x,t.y,Y.x,Y.y,o);if(s.length>0&&s.length<11){var i=s[1][0]-t.x,a=s[1][1]-t.y;2===s.length?t.combatHandler(Y):A.map[s[1][1]][s[1][0]].monster||A.updateActor(i,a,t)}t.regen()},f=function(o){A=new d(t,e,A.depth+o),o>0?A.initializeMap("up"):0>o&&A.initializeMap("down")},d=function(t,e,i){this.rows=e,this.columns=t,this.depth=i,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new y(o,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var s=t.upLeftCornerX+1;s<t.width+t.upLeftCornerX-1;s++)e(s,o)},this.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),s=t.yCenter-Math.floor(t.height/2),i=0;i<t.height;i++)for(var a=0;a<t.width;a++)0===i||i===t.height-1?e[i+s][a+o]=new w(a+o,i+s):(0===a||a===t.width-1)&&(e[i+s][a+o]=new w(a+o,i+s))},this.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var s=t.upLeftCornerX;s<t.upLeftCornerX+t.width;s++)if("wall"===e[o][s].class)return!1;return!0},this.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var o=0,s=0;s<t.length;s++){var i=t[s].xCenter-Math.floor(t[s].width/2),a=t[s].yCenter-Math.floor(t[s].height/2);t:for(var n=0;n<t[s].height;n++)for(var r=0;r<t[s].width;r++)if(0===n||n===t[s].height-1){if(this.checkDoorPath(r+i,n+a,e)){e[n+a][r+i]=new x(r+i,n+a),t[s].doorLocationX=r+i,t[s].doorLocationY=n+a,o++;break t}}else if((0===r||r===t[s].width-1)&&this.checkDoorPath(r+i,n+a,e)){e[n+a][r+i]=new x(r+i,n+a),t[s].doorLocationX=r+i,t[s].doorLocationY=n+a,o++;break t}}return o===t.length?!0:!1},this.popRoom=function(t,e){this.eachTileInRoom(e,function(e,o){t?$(n([e,o])).removeClass("hidden"):$(n([e,o])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,o){for(var s,i,a=this,n=0;n<o.length;n++)o[n].doorLocationX===t&&o[n].doorLocationY===e&&(this.popRoom(!0,o[n]),s=n,i=o[n]);for(var r=0;r<o.length;r++)s!==r&&this.eachTileInRoom(i,function(t,e){o[r].upLeftCornerX===t&&o[r].upLeftCornerY===e&&a.popRoom(!1,o[r])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.lightRoomRogueIn=function(t){for(var e=this,o=0;o<t.length;o++)this.eachTileInRoom(t[o],function(s,i){Y.x===s&&Y.y===i&&e.popRoom(!0,t[o])})},this.randomRoomsCountRecursion=0,this.randomRooms=function(t){for(var e=this.map.map(h),o=[],i=0,n=0;t>n;){if(i++,i>1e5)return console.log("randomRoomsWhile maxed out"),this.randomRooms(t);var r=Math.floor(Math.random()*(this.columns-a)+a/2),c=Math.floor(Math.random()*(this.rows-a)+a/2),l=Math.floor(Math.random()*(a-s)+s),p=Math.floor(Math.random()*(a-s)+s),u=new m(r,c,l,p);this.roomOverlapCheck(u,e)&&(o.push(u),this.createRoom(u,e),n++)}if(!this.doorsUpdateIfPossible(o,e))return this.randomRooms(t);for(var f=0;f<o.length;f++)this.createRoom(o[f],this.map);this.doorsUpdateIfPossible(o,this.map),this.roomList=h(o)},this.createTerrain=function(){var t=new m(Math.floor(this.columns/2),Math.floor(this.rows/2),this.columns,this.rows);this.createRoom(t,this.map),this.randomRooms(o)},this.selectRandomMonster=function(){},this.createMonstersCount=0,this.createMonsters=function(t){for(var e=0;t>e;){if(this.createMonstersCount++,this.createMonstersCount>1e3){console.log("this.createMonstersCount break");break}var o=Math.floor(Math.random()*this.rows),s=Math.floor(Math.random()*this.columns),i=new T(s,o);"dot"===this.map[o][s].class&&(this.map[o][s]=i,I.push(i),e++)}},this.placeStairsCount=0,this.placeStairs=function(t){for(var e=0;1>e;){if(this.placeStairsCount++,this.placeStairsCount>1e3){console.log("placeStairs break");break}var o=Math.floor(Math.random()*this.rows),s=Math.floor(Math.random()*this.columns),i=new v(s,o),a=new M(s,o);"dot"===this.map[o][s].class&&("down"===t?(this.map[o][s]=i,e++):"up"===t&&(this.map[o][s]=a,e++))}return[s,o]},this.placeCharacterStairs=function(t){var e=this.placeStairs(t);Y.x=e[0],Y.y=e[1],this.map[Y.y][Y.x]=Y,this.depth>0?"down"===t?Y.standingOn=new v(Y.x,Y.y):"up"===t&&(Y.standingOn=new M(Y.x,Y.y)):Y.standingOn=new y(Y.x,Y.y)},this.updateDisplay=function(t,e){$(n(t.location())).text(t.text),$(n(t.location())).removeClass(),$(n(t.location())).addClass(t.class+" tile"),2===arguments.length&&($(n(e.location())).removeClass(),$(n(e.location())).addClass(e.class+" tile"),$(n(e.location())).text(e.text))},this.emptyTile=function(t,e){this.map[e][t]=new y(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,o){var s=o.standingOn;o.x+=t,o.y+=e,o.standingOn=this.map[o.y][o.x],this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=s,this.updateDisplay(o,s)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,s=0;Handlebars.registerHelper("columnCounter",function(){return s%o.columns}),Handlebars.registerHelper("rowCounter",function(){return s++,Math.floor(s/o.columns)}),$("#game-window").append(e(o))},this.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var s=[],i=0;i<this.columns;i++)"wall"===t[o][i].class||"door"===t[o][i].class?s.push(1):s.push(0);e.push(s)}return e},this.initializeMap=function(t){I=[],this.createMap(),this.createTerrain(),this.placeCharacterStairs(t),"down"===t?this.placeStairs("up"):"up"===t&&this.placeStairs("down"),this.createMonsters(30),this.drawMap(),this.darkenRooms(this.roomList),this.lightRoomRogueIn(this.roomList)}},m=function(t,e,o,s,i,a){this.xCenter=t,this.yCenter=e,this.width=o,this.height=s,this.doorLocationX=i||null,this.doorLocationY=a||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},y=function(t,e){this.x=t,this.y=e,this.text=".",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};y.prototype.location=function(){return[this.x,this.y]};var g=function(){};g.prototype=new y,g.prototype.constructor=g;var w=function(t,e){y.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};w.prototype=new g,w.prototype.constructor=w;var x=function(t,e){y.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};x.prototype=new g,x.prototype.constructor=x;var v=function(t,e){y.call(this,t,e),this.text=">",this.class="downstairs",this.downStairs=!0,this.inspectText="Stairs leading further into the dungeon. Are you ready for a greater challenge?"};v.prototype=new g,v.prototype.constructor=v,v.prototype.goDown=function(){};var M=function(t,e){y.call(this,t,e),this.text="<",this.class="upstairs",this.upStairs=!0,this.inspectText="Stairs leading up to an easier part of the dungeon."};M.prototype=new g,M.prototype.constructor=M,M.prototype.goUp=function(){};var C=function(t,e){y.call(this,t,e),this.standingOn=new y(t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};C.prototype=new y,C.prototype.constructor=C,C.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},C.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},C.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},C.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,o=100*Math.random();return e>o},C.prototype.combatHandler=function(t){if(this.attackRoll(t)){var e=this.damageRoll();t.health-=e,t.health<0?(l("The "+this.class+" killed the "+t.class+"!"),A.emptyTile(t.x,t.y),t===Y||t.monster&&t.removeActor(I)):l("The "+this.class+" hit the "+t.class+" for "+Math.round(e)+" damage.")}else l("The "+this.class+" missed the "+t.class+".")};var k=function(t,e){C.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.inspectText="A badass MFer.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.inventory=[],this.inventory.push(new D(t,e)),this.inventory.push(new B(t,e))};k.prototype=new C,k.prototype.constructor=k,k.prototype.equip=function(t){t.equipped=!0},k.prototype.checkNextTile=function(t,e){var o=A.map[this.y+e][this.x+t];return o.monster?"monster":o.impassable?"impassable":o.door?"door":o.character?"character":"empty"},k.prototype.keyHandler=function(t){var e,o;108===t?(e=1,o=0):104===t?(e=-1,o=0):106===t?(e=0,o=1):107===t?(e=0,o=-1):117===t?(e=1,o=-1):121===t?(e=-1,o=-1):110===t?(e=1,o=1):98===t?(e=-1,o=1):46===t?(e=0,o=0):62===t?this.standingOn.downStairs?f(1):l("You are not standing on descending stairs."):60===t?this.standingOn.upStairs?f(-1):l("You are not standing on ascending stairs."):105===t?console.log(this.inventory):101===t&&console.log(this.inventory),void 0!==e&&("impassable"===this.checkNextTile(e,o)?l("You shall not pass!"):"monster"===this.checkNextTile(e,o)?(this.combatHandler(A.map[this.y+o][this.x+e]),p()):"door"===this.checkNextTile(e,o)?(A.emptyTile(this.x+e,this.y+o),A.findRoomLightRoom(this.x+e,this.y+o,A.roomList),l("You kick down the door. A loud noise reverberates throughout the dungeon."),p()):"empty"===this.checkNextTile(e,o)?(A.updateActor(e,o,this),p()):"character"===this.checkNextTile(e,o)&&p())};var R=function(t,e){C.call(this,t,e),this.monster=!0};R.prototype=new C,R.prototype.constructor=R;var T=function(t,e){R.call(this,t,e),y.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};T.prototype=new R,T.prototype.constructor=T;var b=function(t,e){R.call(this,t,e),y.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/8,this.health=this.maxHealth,this.offense=this.offenseBase/8,this.defense=this.defenseBase/8,this.maxDamage=this.maxDamageBase/8,this.treasureQuality=2};b.prototype=new R,b.prototype.constructor=b;var L=function(t,e){this.x=t,this.y=e};L.prototype=new y,L.prototype.constructor=L;var S=function(t,e){L.call(this,t,e),this.x=t,this.y=e,this.equipment=!0,this.equipped=!1};S.prototype=new L,S.prototype.constructor=S,S.prototype.takeOff=function(){};var H=function(t,e){S.call(this,t,e),this.x=t,this.y=e,this.weapon=!0};H.prototype=new S,H.prototype.constructor=H;var D=function(t,e){H.call(this,t,e),this.x=t,this.y=e,this.Dagger=!0,this.attackMod=2,this.damageMod=2};D.prototype=new H,D.prototype.constructor=D;var B=function(t,e){H.call(this,t,e),this.x=t,this.y=e,this.sword=!0,this.attackMod=6,this.damageMod=6};B.prototype=new H,B.prototype.constructor=B;var A=new d(t,e,0),Y=new k(1,1),I=[],N=0,P=new PF.AStarFinder({allowDiagonal:!0}),O=function(){console.log("initialize called"),A.initializeMap("up")};return{GameSpace:GameSpace,initialize:O,rogue:Y,clickText:c,currentLevel:A}}();$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()})});