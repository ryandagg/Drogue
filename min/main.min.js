var GameSpace=function(){var t=function(t){return"#column-"+String(t[0])+"-row-"+String(t[1])},e=function(t){$("#messages").prepend("<p>"+t+"</p>")},o=function(){R++,e("------------------- Turn "+R+" -------------------");for(var t=0;t<L.length;t++)i(L[t]);s(M)},a=function(t,e){var o=C.map[M.y+e][M.x+t];return o.monster?"monster":o.impassable?"impassable":o.door?"door":o.character?"character":"empty"},r=function(t){var r,s;108===t?(r=1,s=0):104===t?(r=-1,s=0):106===t?(r=0,s=1):107===t?(r=0,s=-1):117===t?(r=1,s=-1):121===t?(r=-1,s=-1):110===t?(r=1,s=1):98===t?(r=-1,s=1):46===t&&(r=0,s=0),"impassable"===a(r,s)?e("You shall not pass!"):"monster"===a(r,s)?(l(M,C.map[M.y+s][M.x+r]),o()):"door"===a(r,s)?(C.emptyTile(M.x+r,M.y+s),C.findRoomLightRoom(M.x+r,M.y+s,C.roomList),e("You kick down the door. A loud noise reverberates throughout the dungeon."),o()):"empty"===a(r,s)?(C.updateActor(r,s,M),o()):"character"===a(r,s)&&o()},s=function(t){t.health<t.maxHealth&&(t.health+=t.maxHealth/t.regenRate)},i=function(t){var e=C.createPFMatrix(C.map);e[t.y][t.x]=0;var o=new PF.Grid(C.columns,C.rows,e),a=b.findPath(t.x,t.y,M.x,M.y,o);if(a.length>0&&a.length<11){var r=a[1][0]-t.x,i=a[1][1]-t.y;2===a.length?l(t,M):C.map[a[1][1]][a[1][0]].monster||C.updateActor(r,i,t)}s(t)},n=function(t,e){for(var o=0;o<e.length;o++)if(e[o].x===t.x&&e[o].y===t.y){e.splice(o,1);break}},h=function(t){for(var e=0,o=0;o<t.damClump;o++)e+=Math.random()*t.maxDamage/t.damClump;return e},c=function(t,e){var o=t.offense-e.defense+50,a=100*Math.random();return o>a?!0:!1},l=function(t,o){if(c(t,o)){var a=h(t);o.health-=a,o.health<0?(e("The "+t.class+" killed the "+o.class+"!"),C.emptyTile(o.x,o.y),o===M||o.monster&&n(o,L)):e("The "+t.class+" hit the "+o.class+" for "+Math.round(a)+" damage.")}else e("The "+t.class+" missed the "+o.class+".")},f=function(e,o){this.rows=o,this.columns=e,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new m(o,t));this.map.push(e)}},this.cloneMap=function(){for(var t=[],e=0;e<this.map.length;e++)t.push(this.map[e].clone());return t},this.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var a=t.upLeftCornerX+1;a<t.width+t.upLeftCornerX-1;a++)e(a,o)},this.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),a=t.yCenter-Math.floor(t.height/2),r=0;r<t.height;r++)for(var s=0;s<t.width;s++)0===r||r===t.height-1?e[r+a][s+o]=new d(s+o,r+a):(0===s||s===t.width-1)&&(e[r+a][s+o]=new d(s+o,r+a))},this.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var a=t.upLeftCornerX;a<t.upLeftCornerX+t.width;a++)if("wall"===e[o][a].class)return!1;return!0},this.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var o=0,a=0;a<t.length;a++){var r=t[a].xCenter-Math.floor(t[a].width/2),s=t[a].yCenter-Math.floor(t[a].height/2);t:for(var i=0;i<t[a].height;i++)for(var n=0;n<t[a].width;n++)if(0===i||i===t[a].height-1){if(this.checkDoorPath(n+r,i+s,e)){e[i+s][n+r]=new v(n+r,i+s),t[a].doorLocationX=n+r,t[a].doorLocationY=i+s,o++;break t}}else if((0===n||n===t[a].width-1)&&this.checkDoorPath(n+r,i+s,e)){e[i+s][n+r]=new v(n+r,i+s),t[a].doorLocationX=n+r,t[a].doorLocationY=i+s,o++;break t}}return o===t.length?!0:!1},this.popRoom=function(e,o){this.eachTileInRoom(o,function(o,a){e?$(t([o,a])).removeClass("hidden"):$(t([o,a])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,o){for(var a,r,s=this,i=0;i<o.length;i++)o[i].doorLocationX===t&&o[i].doorLocationY===e&&(this.popRoom(!0,o[i]),a=i,r=o[i]);for(var n=0;n<o.length;n++)a!==n&&this.eachTileInRoom(r,function(t,e){o[n].upLeftCornerX===t&&o[n].upLeftCornerY===e&&s.popRoom(!1,o[n])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.randomRooms=function(t){for(var e=4,o=11,a=this.cloneMap(),r=[],s=0;t>s;){var i=Math.floor(Math.random()*(this.columns-o)+o/2),n=Math.floor(Math.random()*(this.rows-o)+o/2),h=Math.floor(Math.random()*(o-e)+e),c=Math.floor(Math.random()*(o-e)+e),l=new u(i,n,h,c);this.roomOverlapCheck(l,a)&&(r.push(l),this.createRoom(l,a),s++)}if(!this.doorsUpdateIfPossible(r,a))return this.randomRooms(t);for(var f=0;f<r.length;f++)this.createRoom(r[f],this.map);this.doorsUpdateIfPossible(r,this.map),this.roomList=r.clone()},this.createTerrain=function(){var t=new u(Math.floor(C.columns/2),Math.floor(C.rows/2),C.columns,C.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*C.rows),a=Math.floor(Math.random()*C.columns),r=new x(a,o);"dot"===C.map[o][a].class&&(C.map[o][a]=r,L.push(r),e++)}},this.placeCharacter=function(){this.map[M.y][M.x]=M},this.updateDisplay=function(e,o){$(t(e.location())).text(e.text),$(t(e.location())).removeClass(),$(t(e.location())).addClass(e.class+" tile"),2===arguments.length&&($(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),$(t(o.location())).text(o.text))},this.emptyTile=function(t,e){this.map[e][t]=new m(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,o){var a=new m(o.x,o.y);o.x+=t,o.y+=e,this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=a,this.updateDisplay(o,a)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,a=0;Handlebars.registerHelper("columnCounter",function(){return a%o.columns}),Handlebars.registerHelper("rowCounter",function(){return a++,Math.floor(a/o.columns)}),$("#game-window").append(e(o))},this.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var a=[],r=0;r<this.columns;r++)"wall"===t[o][r].class||"door"===t[o][r].class?a.push(1):a.push(0);e.push(a)}return e}},u=function(t,e,o,a,r,s){this.xCenter=t,this.yCenter=e,this.width=o,this.height=a,this.doorLocationX=r||null,this.doorLocationY=s||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},m=function(t,e){this.x=t,this.y=e,this.text=".",this.class="dot",this.impassable=!1};m.prototype.location=function(){return[this.x,this.y]};var p=function(){};p.prototype=new m,p.prototype.constructor=p;var d=function(t,e){m.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0};d.prototype=new p,d.prototype.constructor=d;var v=function(t,e){m.call(this,t,e),this.text="+",this.class="door",this.door=!0};v.prototype=new p,v.prototype.constructor=v;var w=function(t,e){m.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.maxHealth=100,this.health=this.maxHealth,this.offense=10,this.defense=10,this.maxDamage=10,this.damClump=3};w.prototype=new m,w.prototype.constructor=w;var y=function(){this.healthBase=100,this.offenseBase=100,this.maxDamageBase=100,this.defenseBase=100,this.damClump=3,this.regenRate=400,this.monster=!0,this.moveSpeed=1};y.prototype=new m,y.prototype.constructor=y;var x=function(t,e){m.call(this,t,e),this.class="rat",this.text="r",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase/10,this.defense=this.defenseBase/10,this.maxDamage=this.maxDamageBase/10,this.treasureQuality=1};x.prototype=new y,x.prototype.constructor=x;var g=function(t,e){m.call(this,t,e),this.class="kobold",this.text="k",this.maxHealth=this.healthBase/8,this.health=this.maxHealth,this.offense=this.offenseBase/8,this.defense=this.defenseBase/8,this.maxDamage=this.maxDamageBase/8,this.treasureQuality=2};g.prototype=new y,g.prototype.constructor=g;var C=new f(60,40),M=new w(1,1),L=[],R=0,b=new PF.AStarFinder({allowDiagonal:!0}),k=function(){C.createMap(),C.createTerrain(),C.placeCharacter(),C.createMonsters(30),C.drawMap(),C.darkenRooms(C.roomList)};return{GameSpace:GameSpace,initialize:k,keyHandler:r,rogue:M,currentLevel:C}}();Object.prototype.clone=function(){var t=this instanceof Array?[]:{};for(i in this)"clone"!=i&&(t[i]=this[i]&&"object"==typeof this[i]?this[i].clone():this[i]);return t},$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.keyHandler(t.charCode)})});