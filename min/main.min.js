var GameSpace=function(){var t=function(t){return"#column-"+String(t[0])+"-row-"+String(t[1])},o=function(t){$("#messages").append("<p>"+t+"</p>")},e=function(t,o){var e=f.map[d.y+o][d.x+t];return e.monster?"monster":e.impassable?"impassable":e.door?"door":"empty"},r=function(t){var r,a;108===t?(r=1,a=0):104===t?(r=-1,a=0):106===t?(r=0,a=1):107===t?(r=0,a=-1):117===t?(r=1,a=-1):121===t?(r=-1,a=-1):110===t?(r=1,a=1):98===t&&(r=-1,a=1),"impassable"===e(r,a)?o("You shall not pass!"):"monster"===e(r,a)||("dot"===e(r,a)?f.updateRogue(r,a):"door"===e(r,a)?(f.emptyTile(d.x+r,d.y+a),f.findRoomLightRoom(d.x+r,d.y+a,f.roomList),o("You kick down the door. A loud noise reverberates throughout the dungeon.")):"empty"===e(r,a)&&f.updateRogue(r,a))},a=function(o,e){this.rows=e,this.columns=o,this.map=[],this.createMap=function(){for(var t=0;t<this.rows;t++){for(var o=[],e=0;e<this.columns;e++)o.push(new s(e,t));this.map.push(o)}},this.cloneMap=function(){for(var t=[],o=0;o<this.map.length;o++)t.push(this.map[o].clone());return t},this.createRoom=function(t,o){for(var e=t.xCenter-Math.floor(t.width/2),r=t.yCenter-Math.floor(t.height/2),a=0;a<t.height;a++)for(var i=0;i<t.width;i++)0===a||a===t.height-1?o[a+r][i+e]=new h(i+e,a+r):(0===i||i===t.width-1)&&(o[a+r][i+e]=new h(i+e,a+r))},this.roomOverlapCheck=function(t,o){for(var e=t.upLeftCornerY;e<t.upLeftCornerY+t.height;e++)for(var r=t.upLeftCornerX;r<t.upLeftCornerX+t.width;r++)if("wall"===o[e][r].class)return!1;return!0},this.checkDoorPath=function(t,o,e){return"dot"===e[o][t-1].class&&"dot"===e[o][t+1].class?!0:"dot"===e[o-1][t].class&&"dot"===e[o+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,o){for(var e=0,r=0;r<t.length;r++){var a=t[r].xCenter-Math.floor(t[r].width/2),i=t[r].yCenter-Math.floor(t[r].height/2);t:for(var s=0;s<t[r].height;s++)for(var n=0;n<t[r].width;n++)if(0===s||s===t[r].height-1){if(this.checkDoorPath(n+a,s+i,o)){o[s+i][n+a]=new c(n+a,s+i),t[r].doorLocationX=n+a,t[r].doorLocationY=s+i,e++;break t}}else if((0===n||n===t[r].width-1)&&this.checkDoorPath(n+a,s+i,o)){o[s+i][n+a]=new c(n+a,s+i),t[r].doorLocationX=n+a,t[r].doorLocationY=s+i,e++;break t}}return e===t.length?!0:!1},this.roomList,this.popRoom=function(o,e){for(var r=e.upLeftCornerY+1;r<e.height+e.upLeftCornerY-1;r++)for(var a=e.upLeftCornerX+1;a<e.width+e.upLeftCornerX-1;a++)o?(console.log(t([a,r])),$(t([a,r])).removeClass("hidden")):$(t([a,r])).addClass("hidden")},this.findRoomLightRoom=function(t,o,e){for(var r=0;r<e.length;r++)if(e[r].doorLocationX===t&&e[r].doorLocationY===o){this.popRoom(!0,e[r]);break}},this.darkenRooms=function(t){for(var o=0;o<t.length;o++)this.popRoom(!1,t[o])},this.randomRooms=function(t){for(var o=4,e=11,r=this.cloneMap(),a=[],s=0;t>s;){var n=Math.floor(Math.random()*(this.columns-e)+e/2),h=Math.floor(Math.random()*(this.rows-e)+e/2),c=Math.floor(Math.random()*(e-o)+o),l=Math.floor(Math.random()*(e-o)+o),p=new i(n,h,c,l);this.roomOverlapCheck(p,r)&&(a.push(p),this.createRoom(p,r),s++)}if(!this.doorsUpdateIfPossible(a,r))return this.randomRooms(t);for(var u=0;u<a.length;u++)this.createRoom(a[u],this.map);this.doorsUpdateIfPossible(a,this.map),this.roomList=a.clone()},this.createTerrain=function(){var t=new i(Math.floor(f.columns/2),Math.floor(f.rows/2),f.columns,f.rows);this.createRoom(t,this.map),this.randomRooms(Math.ceil(Math.sqrt(this.columns*this.rows)/1.5))},this.createMonsters=function(t){for(var o=0;t>o;){var e=Math.floor(Math.random()*f.rows),r=Math.floor(Math.random()*f.columns),a=new u(r,e);"dot"===f.map[e][r].class&&(f.map[e][r]=a,o++)}},this.placeCharacter=function(){this.map[d.y][d.x]=d},this.updateDisplay=function(o,e){$(t(o.location())).text(o.text),$(t(o.location())).removeClass(),$(t(o.location())).addClass(o.class+" tile"),2===arguments.length&&($(t(e.location())).addClass(e.class+" tile"),$(t(e.location())).removeClass(),$(t(e.location())).text(e.text))},this.emptyTile=function(t,o){this.map[o][t]=new s(t,o),this.updateDisplay(this.map[o][t])},this.updateRogue=function(t,o){var e=new s(d.x,d.y);d.x+=t,d.y+=o,this.map[d.y][d.x]=d,this.map[d.y-o][d.x-t]=e,this.updateDisplay(d,e)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),o=Handlebars.compile(t),e=this,r=0;Handlebars.registerHelper("columnCounter",function(){return r%e.columns}),Handlebars.registerHelper("rowCounter",function(){return r++,Math.floor(r/e.columns)}),$("#game-window").append(o(e))}},i=function(t,o,e,r,a,i){this.xCenter=t,this.yCenter=o,this.width=e,this.height=r,this.doorLocationX=a||null,this.doorLocationY=i||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},s=function(t,o){this.x=t,this.y=o,this.text=".",this.class="dot",this.impassable=!1};s.prototype.location=function(){return[this.x,this.y]};var n=function(){};n.prototype=new s,n.prototype.constructor=n;var h=function(t,o){s.call(this,t,o),this.text="#",this.class="wall",this.impassable=!0};h.prototype=new n,h.prototype.constructor=h;var c=function(t,o){s.call(this,t,o),this.text="+",this.class="door",this.door=!0};c.prototype=new n,c.prototype.constructor=c;var l=function(t,o){s.call(this,t,o),this.text="@",this.class="character",this.health=100,this.attack=100,this.defense=100,this.damage=100};l.prototype=new s,l.prototype.constructor=l;var p=function(){this.healthBase=100,this.attackBase=100,this.damageBase=100,this.defenseBase=100,this.monster=!0};p.prototype.attack=function(){},p.prototype=new s,p.prototype.constructor=p;var u=function(t,o){s.call(this,t,o),this.class="rat",this.text="r",this.health=this.healthBase/10,this.attack=this.attackBase/10,this.defense=this.defenseBase/10,this.damage=this.damageBase/10,this.treasureQuality=1};u.prototype=new p,u.prototype.constructor=u;var f=new a(60,40),d=new l(1,1),m=function(){f.createMap(),f.createTerrain(),f.placeCharacter(),f.createMonsters(30),f.drawMap(),f.darkenRooms(f.roomList)};return{initialize:m,rogue:d,currentLevel:f,keyHandler:r}}();Object.prototype.clone=function(){var t=this instanceof Array?[]:{};for(i in this)"clone"!=i&&(t[i]=this[i]&&"object"==typeof this[i]?this[i].clone():this[i]);return t},$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.keyHandler(t.charCode)})});