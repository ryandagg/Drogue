var GameSpace=function(){var t=60,e=40,o=55,s=4,a=8,r=function(t){return"#"+String(t[0])+"-"+String(t[1])},n=function(t){var e=t[0],o="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?o+=t[t.length-1]:(o+=t[t.length-2],o+=t[t.length-1]),[Number(e),Number(o)]},h=function S(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?S(t[i]):t[i]);return e},c=function(t){var e=n(t),o=R.map[e[1]][e[0]];$("#"+t).parent().append("<div class='text-popup'>"+o.inspectText+"</br><span class='close-popup'>close</span></div>")},l=function(t){$("#messages").prepend("<p>"+t+"</p>")},p=function(){D++,l("------------------- Turn "+D+" -------------------");for(var t=0;t<H.length;t++)u(H[t]);b.regen(),$("#HUD").text("HP: "+Math.floor(b.health))},u=function(t){var e=R.createPFMatrix(R.map);e[t.y][t.x]=0;var o=new PF.Grid(R.columns,R.rows,e),s=B.findPath(t.x,t.y,b.x,b.y,o);if(s.length>0&&s.length<11){var a=s[1][0]-t.x,i=s[1][1]-t.y;2===s.length?t.combatHandler(b):R.map[s[1][1]][s[1][0]].monster||R.updateActor(a,i,t)}t.regen()},m=function(t,e){this.rows=e,this.columns=t,this.map=[],this.roomList=null,this.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new d(o,t));this.map.push(e)}},this.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var s=t.upLeftCornerX+1;s<t.width+t.upLeftCornerX-1;s++)e(s,o)},this.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),s=t.yCenter-Math.floor(t.height/2),a=0;a<t.height;a++)for(var i=0;i<t.width;i++)0===a||a===t.height-1?e[a+s][i+o]=new g(i+o,a+s):(0===i||i===t.width-1)&&(e[a+s][i+o]=new g(i+o,a+s))},this.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var s=t.upLeftCornerX;s<t.upLeftCornerX+t.width;s++)if("wall"===e[o][s].class)return!1;return!0},this.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},this.doorsUpdateIfPossible=function(t,e){for(var o=0,s=0;s<t.length;s++){var a=t[s].xCenter-Math.floor(t[s].width/2),i=t[s].yCenter-Math.floor(t[s].height/2);t:for(var r=0;r<t[s].height;r++)for(var n=0;n<t[s].width;n++)if(0===r||r===t[s].height-1){if(this.checkDoorPath(n+a,r+i,e)){e[r+i][n+a]=new x(n+a,r+i),t[s].doorLocationX=n+a,t[s].doorLocationY=r+i,o++;break t}}else if((0===n||n===t[s].width-1)&&this.checkDoorPath(n+a,r+i,e)){e[r+i][n+a]=new x(n+a,r+i),t[s].doorLocationX=n+a,t[s].doorLocationY=r+i,o++;break t}}return o===t.length?!0:!1},this.popRoom=function(t,e){this.eachTileInRoom(e,function(e,o){t?$(r([e,o])).removeClass("hidden"):$(r([e,o])).addClass("hidden")})},this.findRoomLightRoom=function(t,e,o){for(var s,a,i=this,r=0;r<o.length;r++)o[r].doorLocationX===t&&o[r].doorLocationY===e&&(this.popRoom(!0,o[r]),s=r,a=o[r]);for(var n=0;n<o.length;n++)s!==n&&this.eachTileInRoom(a,function(t,e){o[n].upLeftCornerX===t&&o[n].upLeftCornerY===e&&i.popRoom(!1,o[n])})},this.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},this.randomRooms=function(t){for(var e=this.map.map(h),o=[],i=0;t>i;){var r=Math.floor(Math.random()*(this.columns-a)+a/2),n=Math.floor(Math.random()*(this.rows-a)+a/2),c=Math.floor(Math.random()*(a-s)+s),l=Math.floor(Math.random()*(a-s)+s),p=new f(r,n,c,l);this.roomOverlapCheck(p,e)&&(o.push(p),this.createRoom(p,e),i++)}if(!this.doorsUpdateIfPossible(o,e))return this.randomRooms(t);for(var u=0;u<o.length;u++)this.createRoom(o[u],this.map);this.doorsUpdateIfPossible(o,this.map),this.roomList=h(o)},this.createTerrain=function(){var t=new f(Math.floor(this.columns/2),Math.floor(this.rows/2),this.columns,this.rows);this.createRoom(t,this.map),this.randomRooms(o)},this.selectRandomMonster=function(){},this.createMonsters=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*this.rows),s=Math.floor(Math.random()*this.columns),a=new T(s,o);"dot"===this.map[o][s].class&&(this.map[o][s]=a,H.push(a),e++)}},this.placeStairs=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*this.rows),s=Math.floor(Math.random()*this.columns),a=new v(s,o);"dot"===this.map[o][s].class&&(this.map[o][s]=a,e++)}for(var i=0;t>i;){var o=Math.floor(Math.random()*this.rows),s=Math.floor(Math.random()*this.columns),r=new w(s,o);"dot"===this.map[o][s].class&&(this.map[o][s]=r,i++)}},this.placeCharacter=function(){this.map[b.y][b.x]=b},this.updateDisplay=function(t,e){console.log("updateDisplay obj2",e),$(r(t.location())).text(t.text),$(r(t.location())).removeClass(),$(r(t.location())).addClass(t.class+" tile"),2===arguments.length&&($(r(e.location())).removeClass(),$(r(e.location())).addClass(e.class+" tile"),$(r(e.location())).text(e.text))},this.emptyTile=function(t,e){this.map[e][t]=new d(t,e),this.updateDisplay(this.map[e][t])},this.updateActor=function(t,e,o){var s=o.standingOn;o.x+=t,o.y+=e,o.standingOn=this.map[o.y][o.x],this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=s,this.updateDisplay(o,s)},this.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,s=0;Handlebars.registerHelper("columnCounter",function(){return s%o.columns}),Handlebars.registerHelper("rowCounter",function(){return s++,Math.floor(s/o.columns)}),$("#game-window").append(e(o))},this.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var s=[],a=0;a<this.columns;a++)"wall"===t[o][a].class||"door"===t[o][a].class?s.push(1):s.push(0);e.push(s)}return e}},f=function(t,e,o,s,a,i){this.xCenter=t,this.yCenter=e,this.width=o,this.height=s,this.doorLocationX=a||null,this.doorLocationY=i||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},d=function(t,e){this.x=t,this.y=e,this.text=".",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};d.prototype.location=function(){return[this.x,this.y]};var y=function(){};y.prototype=new d,y.prototype.constructor=y;var g=function(t,e){d.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};g.prototype=new y,g.prototype.constructor=g;var x=function(t,e){d.call(this,t,e),this.text="+",this.class="door",this.door=!0,this.inspectText="A door. I wonder what is on the other side."};x.prototype=new y,x.prototype.constructor=x;var v=function(t,e){d.call(this,t,e),this.text=">",this.class="downstairs",this.inspectText="Stairs leading further into the dungeon. Are you ready for a greater challenge?"};v.prototype=new y,v.prototype.constructor=v,v.prototype.goDown=function(){};var w=function(t,e){d.call(this,t,e),this.text="<",this.class="upstairs",this.inspectText="Stairs leading up to an easier part of the dungeon."};w.prototype=new y,w.prototype.constructor=w,w.prototype.goUp=function(){};var M=function(t,e){d.call(this,t,e),this.standingOn=new d(t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};M.prototype=new d,M.prototype.constructor=M,M.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},M.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},M.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},M.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,o=100*Math.random();return e>o},M.prototype.combatHandler=function(t){if(this.attackRoll(t)){var e=this.damageRoll();t.health-=e,t.health<0?(l("The "+this.class+" killed the "+t.class+"!"),R.emptyTile(t.x,t.y),t===b||t.monster&&t.removeActor(H)):l("The "+this.class+" hit the "+t.class+" for "+Math.round(e)+" damage.")}else l("The "+this.class+" missed the "+t.class+".")};var C=function(t,e){M.call(this,t,e),this.text="@",this.class="character",this.character=!0,this.inspectText="A badass MFer.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase};C.prototype=new M,C.prototype.constructor=C,C.prototype.checkNextTile=function(t,e){var o=R.map[this.y+e][this.x+t];return o.monster?"monster":o.impassable?"impassable":o.door?"door":o.character?"character":"empty"},C.prototype.keyHandler=function(t){var e,o;108===t?(e=1,o=0):104===t?(e=-1,o=0):106===t?(e=0,o=1):107===t?(e=0,o=-1):117===t?(e=1,o=-1):121===t?(e=-1,o=-1):110===t?(e=1,o=1):98===t?(e=-1,o=1):46===t&&(e=0,o=0),"impassable"===this.checkNextTile(e,o)?l("You shall not pass!"):"monster"===this.checkNextTile(e,o)?(this.combatHandler(R.map[this.y+o][this.x+e]),p()):"door"===this.checkNextTile(e,o)?(R.emptyTile(this.x+e,this.y+o),R.findRoomLightRoom(this.x+e,this.y+o,R.roomList),l("You kick down the door. A loud noise reverberates throughout the dungeon."),p()):"empty"===this.checkNextTile(e,o)?(R.updateActor(e,o,this),p()):"character"===this.checkNextTile(e,o)&&p()};var k=function(t,e){M.call(this,t,e),this.monster=!0};k.prototype=new M,k.prototype.constructor=k;var T=function(t,e){k.call(this,t,e),d.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};T.prototype=new k,T.prototype.constructor=T;var L=function(t,e){k.call(this,t,e),d.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/8,this.health=this.maxHealth,this.offense=this.offenseBase/8,this.defense=this.defenseBase/8,this.maxDamage=this.maxDamageBase/8,this.treasureQuality=2};L.prototype=new k,L.prototype.constructor=L;var R=new m(t,e),b=new C(1,1),H=[],D=0,B=new PF.AStarFinder({allowDiagonal:!0}),A=function(){R.createMap(),R.mapInitialize,R.createTerrain(),R.placeCharacter(),R.placeStairs(1),R.createMonsters(30),R.drawMap(),R.darkenRooms(R.roomList)};return{GameSpace:GameSpace,initialize:A,rogue:b,clickText:c,currentLevel:R}}();$(document).on("ready",function(){GameSpace.initialize(),$(document).keypress(function(t){GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()})});