var GameSpace=function(){var t=60,e=40,o=50,n=4,s=9,r=30,a=function(){var t=.85*$(window).height(),e=.75*$(window).width();$(".tile").width(e/GameSpace.currentLevel.columns),$(".tile").height(t/GameSpace.currentLevel.rows)},h=function(){$(".scale-font").css("font-size",1.05*$(".tile").height())},l=function(t){return"#"+String(t[0])+"-"+String(t[1])},p=function(t){var e=t[0],o="";return isNaN(t[1])||(e+=t[1]),isNaN(t[t.length-2])?o+=t[t.length-1]:(o+=t[t.length-2],o+=t[t.length-1]),[Number(e),Number(o)]},c=function K(t){var e=t instanceof Array?[]:{};for(i in t)"clone"!=i&&(e[i]=t[i]&&"object"==typeof t[i]?K(t[i]):t[i]);return e},u=function(t){var e=p(t),o=N.map[e[1]][e[0]];$("#"+t).parent().append("<div class='text-popup'>"+o.inspectText+"</br><span class='close-popup'>close</span></div>")},f=function(t){$("#messages").prepend("<p class='a-message'>"+t+"</p>")},d=function(){for(var t=0;t<U.length;t++)m(U[t]);X.regen(),$("#hp").text("HP: "+Math.floor(X.health)),E++,f("----------- Turn "+E+" -----------")},m=function(t){var e=N.createPFMatrix(N.map),o=new PF.Grid(N.columns,N.rows,e),i=Q.findPath(t.x,t.y,X.x,X.y,o);if(i.length>0&&i.length<11){var n=i[1][0]-t.x,s=i[1][1]-t.y;2===i.length?t.combatHandler(X):N.map[i[1][1]][i[1][0]]instanceof S||N.updateActor(n,s,t)}t.regen()},y=function(o){N=new v(t,e,N.depth+o),o>0?N.initializeMap("up"):0>o&&N.initializeMap("down"),a(),h()},v=function(t,e,o){this.rows=e,this.columns=t,this.depth=o,this.map=[],this.roomList=null};v.prototype.createMap=function(){for(var t=0;t<this.rows;t++){for(var e=[],o=0;o<this.columns;o++)e.push(new w(o,t));this.map.push(e)}},v.prototype.eachTileInRoom=function(t,e){for(var o=t.upLeftCornerY+1;o<t.height+t.upLeftCornerY-1;o++)for(var i=t.upLeftCornerX+1;i<t.width+t.upLeftCornerX-1;i++)e(i,o)},v.prototype.createRoom=function(t,e){for(var o=t.xCenter-Math.floor(t.width/2),i=t.yCenter-Math.floor(t.height/2),n=0;n<t.height;n++)for(var s=0;s<t.width;s++)0===n||n===t.height-1?e[n+i][s+o]=new M(s+o,n+i):(0===s||s===t.width-1)&&(e[n+i][s+o]=new M(s+o,n+i))},v.prototype.roomOverlapCheck=function(t,e){for(var o=t.upLeftCornerY;o<t.upLeftCornerY+t.height;o++)for(var i=t.upLeftCornerX;i<t.upLeftCornerX+t.width;i++)if("wall"===e[o][i].class)return!1;return!0},v.prototype.checkDoorPath=function(t,e,o){return"dot"===o[e][t-1].class&&"dot"===o[e][t+1].class?!0:"dot"===o[e-1][t].class&&"dot"===o[e+1][t].class?!0:!1},v.prototype.doorsUpdateIfPossible=function(t,e){for(var o=0,i=0;i<t.length;i++){var n=t[i].xCenter-Math.floor(t[i].width/2),s=t[i].yCenter-Math.floor(t[i].height/2);t:for(var r=0;r<t[i].height;r++)for(var a=0;a<t[i].width;a++)if(0===r||r===t[i].height-1){if(this.checkDoorPath(a+n,r+s,e)){e[r+s][a+n]=new C(a+n,r+s),t[i].doorLocationX=a+n,t[i].doorLocationY=r+s,o++;break t}}else if((0===a||a===t[i].width-1)&&this.checkDoorPath(a+n,r+s,e)){e[r+s][a+n]=new C(a+n,r+s),t[i].doorLocationX=a+n,t[i].doorLocationY=r+s,o++;break t}}return o===t.length?!0:!1},v.prototype.popRoom=function(t,e){this.eachTileInRoom(e,function(e,o){t?$(l([e,o])).removeClass("hidden"):$(l([e,o])).addClass("hidden")})},v.prototype.findRoomLightRoom=function(t,e,o){for(var i,n,s=this,r=0;r<o.length;r++)o[r].doorLocationX===t&&o[r].doorLocationY===e&&(this.popRoom(!0,o[r]),i=r,n=o[r]);for(var a=0;a<o.length;a++)i!==a&&this.eachTileInRoom(n,function(t,e){o[a].upLeftCornerX===t&&o[a].upLeftCornerY===e&&s.popRoom(!1,o[a])})},v.prototype.darkenRooms=function(t){for(var e=0;e<t.length;e++)this.popRoom(!1,t[e])},v.prototype.lightRoomRogueIn=function(t){for(var e=this,o=0;o<t.length;o++)this.eachTileInRoom(t[o],function(i,n){X.x===i&&X.y===n&&e.popRoom(!0,t[o])})},v.prototype.randomRooms=function(t){for(var e=this.map.map(c),o=[],i=0,r=0;t>r;){if(i++,i>1e5)return console.log("randomRoomsWhile maxed out"),this.randomRooms(t);var a=Math.floor(Math.random()*(this.columns-s)+s/2),h=Math.floor(Math.random()*(this.rows-s)+s/2),l=Math.floor(Math.random()*(s-n)+n),p=Math.floor(Math.random()*(s-n)+n),u=new g(a,h,l,p);this.roomOverlapCheck(u,e)&&(o.push(u),this.createRoom(u,e),r++)}if(console.log(i),!this.doorsUpdateIfPossible(o,e))return this.randomRooms(t);for(var f=0;f<o.length;f++)this.createRoom(o[f],this.map);this.doorsUpdateIfPossible(o,this.map),this.roomList=c(o)},v.prototype.createTerrain=function(){var t=new g(Math.floor(this.columns/2),Math.floor(this.rows/2),this.columns,this.rows);this.createRoom(t,this.map),this.randomRooms(o)},v.prototype.selectRandomMonster=function(){},v.prototype.createMonsters=function(t){for(var e=0;t>e;){var o=Math.floor(Math.random()*this.rows),i=Math.floor(Math.random()*this.columns);if(0===this.depth)var n=new H(i,o);else if(1===this.depth)var n=new k(i,o);else if(2===this.depth)var n=new D(i,o);"dot"===this.map[o][i].class&&(this.map[o][i]=n,U.push(n),e++)}},v.prototype.placeStairs=function(t){for(var e=0;1>e;){var o=Math.floor(Math.random()*this.rows),i=Math.floor(Math.random()*this.columns),n=new b(i,o),s=new R(i,o);"dot"===this.map[o][i].class&&("down"===t?(this.map[o][i]=n,e++):"up"===t&&(this.map[o][i]=s,e++))}return[i,o]},v.prototype.placeCharacterStairs=function(t){var e=this.placeStairs(t);X.x=e[0],X.y=e[1],this.map[X.y][X.x]=X,this.depth>0?"down"===t?X.standingOn=new b(X.x,X.y):"up"===t&&(X.standingOn=new R(X.x,X.y)):X.standingOn=new w(X.x,X.y)},v.prototype.updateDisplay=function(t,e){$(l(t.location())).text(t.text),$(l(t.location())).removeClass(),$(l(t.location())).addClass(t.class+" tile"),2===arguments.length&&($(l(e.location())).removeClass(),$(l(e.location())).addClass(e.class+" tile"),$(l(e.location())).text(e.text))},v.prototype.emptyTile=function(t,e){this.map[e][t]=new w(t,e),this.updateDisplay(this.map[e][t])},v.prototype.updateActor=function(t,e,o){var i=o.standingOn;o.x+=t,o.y+=e,o.standingOn=this.map[o.y][o.x],this.map[o.y][o.x]=o,this.map[o.y-e][o.x-t]=i,this.updateDisplay(o,i)},v.prototype.drawMap=function(){$("#game-window").empty();var t=$("#game-window-template").html(),e=Handlebars.compile(t),o=this,i=0;Handlebars.registerHelper("columnCounter",function(){return i%o.columns}),Handlebars.registerHelper("rowCounter",function(){return i++,Math.floor(i/o.columns)}),$("#game-window").append(e(o))},v.prototype.createPFMatrix=function(t){for(var e=[],o=0;o<this.rows;o++){for(var i=[],n=0;n<this.columns;n++)"wall"===t[o][n].class||"door"===t[o][n].class?i.push(1):i.push(0);e.push(i)}return e},v.prototype.initializeMap=function(t){U=[],this.createMap(),this.createTerrain(),this.placeCharacterStairs(t),"down"===t?this.placeStairs("up"):"up"===t&&this.placeStairs("down"),this.createMonsters(r),this.drawMap(),this.darkenRooms(this.roomList),this.lightRoomRogueIn(this.roomList)};var g=function(t,e,o,i,n,s){this.xCenter=t,this.yCenter=e,this.width=o,this.height=i,this.doorLocationX=n||null,this.doorLocationY=s||null,this.upLeftCornerX=this.xCenter-Math.floor(this.width/2),this.upLeftCornerY=this.yCenter-Math.floor(this.height/2)},w=function(t,e){this.x=t,this.y=e,this.text="Â·",this.class="dot",this.impassable=!1,this.inspectText="A dank dungeon floor."};w.prototype.location=function(){return[this.x,this.y]};var x=function(){};x.prototype=new w,x.prototype.constructor=x;var M=function(t,e){w.call(this,t,e),this.text="#",this.class="wall",this.impassable=!0,this.inspectText="A solid wall."};M.prototype=new x,M.prototype.constructor=M;var C=function(t,e){w.call(this,t,e),this.text="+",this.class="door",this.inspectText="A door. I wonder what is on the other side."};C.prototype=new x,C.prototype.constructor=C;var b=function(t,e){w.call(this,t,e),this.text=">",this.class="downstairs",this.inspectText="Stairs leading further into the dungeon. Are you ready for a greater challenge?"};b.prototype=new x,b.prototype.constructor=b,b.prototype.goDown=function(){};var R=function(t,e){w.call(this,t,e),this.text="<",this.class="upstairs",this.inspectText="Stairs leading up to an easier part of the dungeon."};R.prototype=new x,R.prototype.constructor=R,R.prototype.goUp=function(){};var T=function(t,e){w.call(this,t,e),this.standingOn=new w(t,e),this.healthBase=100,this.offenseBase=10,this.maxDamageBase=10,this.defenseBase=10,this.damClump=3,this.regenRate=400,this.moveSpeed=1};T.prototype=new w,T.prototype.constructor=T,T.prototype.regen=function(){this.health<this.maxHealth&&(this.health+=this.maxHealth/this.regenRate)},T.prototype.removeActor=function(t){for(var e=0;e<t.length;e++)if(t[e].x===this.x&&t[e].y===this.y){t.splice(e,1);break}},T.prototype.damageRoll=function(){for(var t=0,e=0;e<this.damClump;e++)t+=Math.random()*this.maxDamage/this.damClump;return t},T.prototype.attackRoll=function(t){var e=this.offense-t.defense+50,o=100*Math.random();return e>o},T.prototype.combatHandler=function(o){if(this.attackRoll(o)){var i=this.damageRoll();if(o.health-=i,o.health<0){if(f("The "+this.class+" killed the "+o.class+"!"),N.emptyTile(o.x,o.y),o===X)N=new v(t,e),$("#game-window").empty(),$("#game-wrapper").prepend("<div id='dead'>YOU SUCK AND YOU'RE DEAD. lolz<br>You had "+X.gold+" gold.</div>");else if(o instanceof S){o.removeActor(U);var n=o.lootDrop();N.map[o.y][o.x]=n,N.updateDisplay(o,n)}}else f("The "+this.class+" hit the "+o.class+" for "+Math.round(i)+" damage.")}else f("The "+this.class+" missed the "+o.class+".")};var L=function(t,e){T.call(this,t,e),this.text="@",this.class="character",this.inspectText="A badass MFer.",this.inventoryOpen=!1,this.inventoryFocus=null,this.tunneling=!1,this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.gold=0,this.inventory={a:null,b:null,c:null,d:null,e:null,f:null,g:null,h:null,i:null,j:null,k:null,l:null,m:null,n:null,o:null,p:null,q:null,r:null,s:null,t:null,u:null,v:null,x:null,y:null,z:null},this.inventory.a=new I(t,e,!1),this.inventory.b=new z(t,e,!1)};L.prototype=new T,L.prototype.constructor=L,L.prototype.openInventorySlot=function(){for(var t in this.inventory)if(console.log("this.inventory.i: ",this.inventory.i),null===this.inventory[t])return console.log("i: ",t),t;return!1},L.prototype.inventoryHandler=function(t){var e=function(t){t.inventoryFocus=null,t.inventoryOpen=!1,t.drawInventory(),d()};if(!(t>=97&&122>=t))return f("That is not an item"),this.inventoryHandler();var o={97:"a",98:"b",99:"c",100:"d",101:"e",102:"f",103:"g",104:"h",105:"i",106:"j",107:"k",108:"l",109:"m",110:"n",111:"o",112:"p",113:"q",114:"r",115:"s",116:"t",117:"u",118:"v",119:"w",120:"x",121:"x",122:"z"};if(this.inventoryFocus){if(101===t){if(!(this.inventoryFocus instanceof B))return f("That is not equipment"),this.inventoryHandler();this.equip(this.inventoryFocus),f("You have "+this.inventoryFocus+"."),e(this)}else if(117===t){if(!(this.inventoryFocus instanceof B))return f("That is not equipment"),this.inventoryHandler();this.unEquip(this.inventoryFocus),e(this)}}else{var i=o[t];if(console.log(i),null===this.inventory[i])return f("That is not an item"),this.inventoryHandler();f("Do what with the "+this.inventory[i].toString()+"?"),f("drop (d), equip (e), use (u), unequip (u)"),this.inventoryFocus=this.inventory[i],console.log(this.inventoryFocus instanceof B)}},L.prototype.equip=function(t){t.equipped=!0,this.offense+=t.offenseMod,this.maxDamage+=t.damageMod,this.defense+=t.defenseMod},L.prototype.unEquip=function(t){t.equipped=!1,this.offense-=t.offenseMod,this.maxDamage-=t.damageMod,this.defense-=t.defenseMod},L.prototype.directionalMovementHandler=function(t,e){var o=N.map[this.y+e][this.x+t];if(o.impassable&&this.tunneling){for(var i=0;20>i;i++)d();f("You dig through the wall with your pick."),N.emptyTile(this.x+t,this.y+e),this.tunneling=!1}else if(o.impassable)f("You shall not pass!");else if(o instanceof S)this.combatHandler(N.map[this.y+e][this.x+t]),d();else if(o instanceof C)N.emptyTile(this.x+t,this.y+e),N.findRoomLightRoom(this.x+t,this.y+e,N.roomList),f("You kick down the door. A loud noise reverberates throughout the dungeon."),d();else if(o instanceof L)d();else if(o instanceof q)this.gold+=N.map[this.y+e][this.x+t].quantity,N.map[this.y+e][this.x+t]=new w(this.x+t,this.y+e),N.updateActor(t,e,this),$("#gold").text("Gold: "+this.gold),d();else if(o instanceof A)if(this.openInventorySlot()){var n=this.openInventorySlot();this.inventory[n]=N.map[this.y+e][this.x+t],N.map[this.y+e][this.x+t]=new w(this.x+t,this.y+e),N.updateActor(t,e,this),d()}else N.updateActor(t,e,this),d();else N.updateActor(t,e,this),d()},L.prototype.nonDirectionalMovementHandler=function(t){if(62===t)this.standingOn instanceof b?y(1):f("You are not standing on descending stairs.");else if(60===t)this.standingOn instanceof R?y(-1):f("You are not standing on ascending stairs.");else if(105===t)this.inventoryOpen=!0,f("------INVENTORY OPEN------"),f("(close with 'Q')"),f("Interact with which item?");else if(82===t)for(var e=0;100>e;e++)d();else 84===t&&(this.tunneling=!0,f("--- Tunnel in which direction? ---"))},L.prototype.keyHandler=function(t){var e,o;81===t?(this.inventoryOpen=!1,this.inventoryFocus=null):this.inventoryOpen?this.inventoryHandler(t):(!this.inventoryOpen||this.tunneling)&&(108===t?(e=1,o=0):104===t?(e=-1,o=0):106===t?(e=0,o=1):107===t?(e=0,o=-1):117===t?(e=1,o=-1):121===t?(e=-1,o=-1):110===t?(e=1,o=1):98===t?(e=-1,o=1):46===t&&(e=0,o=0,this.tunneling=!1),this.tunneling||this.nonDirectionalMovementHandler(t),void 0!==e&&this.directionalMovementHandler(e,o))},L.prototype.drawInventory=function(){$("#inventory").empty();for(var t in this.inventory)$("#inventory").append(t+": "+this.inventory[t]+"<br>")};var S=function(t,e){T.call(this,t,e)};S.prototype=new T,S.prototype.constructor=S,S.prototype.lootDrop=function(){return 100*Math.random()<this.treasureQuality?new P(this.x,this.y):new q(this.x,this.y,this.treasureQuality)};var H=function(t,e){S.call(this,t,e),w.call(this,t,e),this.class="rat",this.text="r",this.inspectText="A enormous, mangy rat. It looks hungry.",this.maxHealth=this.healthBase/10,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=1};H.prototype=new S,H.prototype.constructor=H;var k=function(t,e){S.call(this,t,e),w.call(this,t,e),this.class="kobold",this.text="k",this.inspectText="A short, reptilian humanoid. It walks on two legs and wants to stab you.",this.maxHealth=this.healthBase/5,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase/2,this.maxDamage=this.maxDamageBase/3,this.treasureQuality=2};k.prototype=new S,k.prototype.constructor=k;var D=function(t,e){S.call(this,t,e),w.call(this,t,e),this.class="goblin",this.text="g",this.inspectText="A short, twisted version of a man.",this.maxHealth=this.healthBase,this.health=this.maxHealth,this.offense=this.offenseBase,this.defense=this.defenseBase,this.maxDamage=this.maxDamageBase,this.treasureQuality=3};D.prototype=new S,D.prototype.constructor=D;var A=function(t,e){this.x=t,this.y=e};A.prototype=new w,A.prototype.constructor=A,A.prototype.toString=function(){return this.label};var B=function(t,e,o){A.call(this,t,e),this.x=t,this.y=e,this.equipped=o||!1,this.enchantLevel=0,this.offenseMod=0,this.damageMod=0,this.defenseMod=0};B.prototype=new A,B.prototype.constructor=B,B.prototype.toString=function(){return this.equipped?"equipped "+this.label+" "+this.enchantLevel:this.label+" "+this.enchantLevel};var F=function(t,e,o){B.call(this,t,e,o),this.x=t,this.y=e,this.weapon=!0,this.text="^",this.class="weapon"};F.prototype=new B,F.prototype.constructor=F;var I=function(t,e,o){F.call(this,t,e,o),this.x=t,this.y=e,this.label="Dagger",this.offenseMod=10,this.damageMod=2};I.prototype=new F,I.prototype.constructor=I;var O=function(t,e,o){F.call(this,t,e,o),this.x=t,this.y=e,this.label="Sword",this.offenseMod=5,this.damageMod=8};O.prototype=new F,O.prototype.constructor=O;var Y=function(t,e,o){B.call(this,t,e,o),this.x=t,this.y=e,this.text=")",this.class="armor"};Y.prototype=new B,Y.prototype.constructor=Y;var z=function(t,e,o){Y.call(this,t,e,o),this.x=t,this.y=e,this.label="Leather Armor",this.defenseMod=2};z.prototype=new Y,z.prototype.constructor=z;var q=function(t,e,o){A.call(this,t,e),this.x=t,this.y=e,this.text="$",this.class="gold",this.quantity=o};q.prototype=new A,q.prototype.constructor=q;var G=function(t,e){A.call(this,t,e),this.x=t,this.y=e,this.text="~",this.class="scroll"};G.prototype=new A,G.prototype.constructor=G;var P=function(t,e){A.call(this,t,e),this.x=t,this.y=e,this.label="Scroll of enchantment"};P.prototype=new A,P.prototype.constructor=P;var N=new v(t,e,0),X=new L(1,1),U=[],E=0,Q=new PF.AStarFinder({allowDiagonal:!0,dontCrossCorners:!1}),j=function(){console.log("initialize called"),N.initializeMap("up"),X.drawInventory()};return{GameSpace:GameSpace,initialize:j,rogue:X,clickText:u,currentLevel:N,resizeTiles:a,resizeFont:h}}();$(document).on("ready",function(){try{GameSpace.initialize()}catch(t){console.log("initialize failed"),setTimeout(function(){throw t},100)}$(document).keypress(function(t){GameSpace.rogue.keyHandler(t.charCode)}),$(document).on("click",".tile",function(){GameSpace.clickText($(this).attr("id"))}),$(document).on("click",".close-popup",function(){$(".text-popup").remove()}),GameSpace.resizeTiles(),GameSpace.resizeFont(),$(window).resize(function(){GameSpace.resizeTiles(),GameSpace.resizeFont()})});